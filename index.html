<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NOTECRAFT: Incremental Music Empire</title>
  <style>
    :root{
      --bg0:#07080d;
      --bg1:#0b0f1c;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.085);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.9);
      --muted:rgba(255,255,255,.65);
      --muted2:rgba(255,255,255,.45);
      --good:#7CFFB2;
      --warn:#FFD37C;
      --bad:#FF7C9A;
      --acc:#B47CFF;
      --acc2:#7CE1FF;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --r:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(180,124,255,.22), transparent 70%),
        radial-gradient(700px 500px at 80% 20%, rgba(124,225,255,.18), transparent 70%),
        radial-gradient(700px 600px at 60% 90%, rgba(124,255,178,.12), transparent 70%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      overflow-x:hidden;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:22px 16px 24px;
    }

    .top{
      display:flex;
      gap:14px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    .brand{
      flex: 1 1 360px;
      padding:18px 18px;
      border:1px solid var(--stroke);
      background:linear-gradient(135deg, rgba(180,124,255,.14), rgba(124,225,255,.08));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .brand:before{
      content:"";
      position:absolute; inset:-120px -120px auto auto;
      width:260px; height:260px;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 60%);
      filter: blur(2px);
      transform: rotate(18deg);
    }
    .brand h1{
      margin:0 0 6px;
      font-size:20px;
      letter-spacing:.6px;
      font-weight:800;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      line-height:1.3;
      font-size:13px;
    }

    .stats{
      flex: 2 1 520px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .stat{
      padding:12px 12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      box-shadow: 0 12px 40px rgba(0,0,0,.30);
    }
    .stat .k{font-size:11px;color:var(--muted2);letter-spacing:.35px}
    .stat .v{font-size:16px;font-weight:800;margin-top:4px}
    .stat .s{font-size:11px;color:var(--muted);margin-top:6px}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.2fr .9fr .9fr;
      gap:12px;
    }

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
      overflow:hidden;
      position:relative;
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.4px;
      color:rgba(255,255,255,.88);
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      margin:8px 0 0;
      line-height:1.35;
    }

    .clickZone{
      display:flex;
      flex-direction:column;
      gap:12px;
      height:100%;
      min-height:410px;
    }
    .bigBtn{
      flex:1;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(500px 300px at 30% 20%, rgba(124,225,255,.20), transparent 70%),
        radial-gradient(500px 320px at 70% 80%, rgba(180,124,255,.22), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
      user-select:none;
    }
    .bigBtn:active{ transform: scale(.985); }
    .bigBtn:hover{ border-color: rgba(255,255,255,.22); filter: brightness(1.03); }

    .bigBtn .inner{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:10px;
      padding:16px;
      text-align:center;
    }
    .note{
      font-size:44px;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.45));
      animation: floaty 3.2s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(0) }
      50%{ transform: translateY(-6px) }
    }
    .bigBtn .title{
      font-size:16px;
      font-weight:900;
      letter-spacing:.6px;
    }
    .bigBtn .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      max-width:460px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:stretch;
    }
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.3px;
      font-size:12px;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      min-height:42px;
    }
    .btn:hover{ border-color: rgba(255,255,255,.24); background:rgba(255,255,255,.07); }
    .btn:active{ transform: scale(.985); }
    .btn.good{ border-color: rgba(124,255,178,.28); background: rgba(124,255,178,.08); }
    .btn.acc{ border-color: rgba(180,124,255,.28); background: rgba(180,124,255,.08); }
    .btn.warn{ border-color: rgba(255,211,124,.30); background: rgba(255,211,124,.08); }
    .btn.danger{ border-color: rgba(255,124,154,.28); background: rgba(255,124,154,.07); }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter: grayscale(.2);
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:460px;
      overflow:auto;
      padding-right:6px;
    }
    .list::-webkit-scrollbar{ width:8px; }
    .list::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.10);
      border-radius:999px;
    }

    .item{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius:16px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .item .name{
      font-weight:900;
      letter-spacing:.25px;
      font-size:12px;
    }
    .item .desc{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }
    .item .meta{
      margin-top:8px;
      font-size:11px;
      color:rgba(255,255,255,.78);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .tag{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.78);
      background:rgba(255,255,255,.03);
      letter-spacing:.3px;
    }
    .tag.lock{ border-color: rgba(255,124,154,.22); background: rgba(255,124,154,.08); }
    .tag.reb{ border-color: rgba(180,124,255,.28); background: rgba(180,124,255,.08); }
    .tag.vip{ border-color: rgba(124,225,255,.26); background: rgba(124,225,255,.08); }

    .toastHost{
      position:fixed;
      right:14px;
      bottom:14px;
      width:min(420px, calc(100vw - 28px));
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:50;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      transform: translateY(10px);
      opacity:0;
      transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show{ opacity:1; transform: translateY(0); }
    .toast .t{ font-weight:900; font-size:12px; }
    .toast .b{ color:var(--muted); font-size:11px; margin-top:6px; line-height:1.35; }

    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:60;
    }
    .modal{
      width:min(980px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(600px 420px at 20% 0%, rgba(180,124,255,.20), transparent 70%),
        radial-gradient(600px 420px at 90% 30%, rgba(124,225,255,.16), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .modalHeader .ttl{
      font-weight:900;
      letter-spacing:.4px;
      font-size:13px;
    }
    .modalBody{
      padding:12px 14px 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      max-height: 78vh;
      overflow:auto;
    }
    .modalFooter{
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.12);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .mini{
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }
    .pillRow{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }

    .spark{
      position:fixed;
      pointer-events:none;
      font-weight:900;
      text-shadow: 0 10px 22px rgba(0,0,0,.55);
      will-change: transform, opacity;
      z-index:40;
    }

    @media (max-width: 980px){
      .stats{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .grid{ grid-template-columns: 1fr; }
      .clickZone{ min-height: 340px; }
      .modalBody{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>NOTECRAFT</h1>
        <p>–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª-–∏–º–ø–µ—Ä–∏—è –º—É–∑—ã–∫–∏: –∫–ª–∏–∫–∞–π –Ω–æ—Ç—ã, –∫–∞—á–∞–π —Å—Ç—É–¥–∏—é, –≤—ã–ø—É—Å–∫–∞–π —Ö–∏—Ç—ã, –¥–µ–ª–∞–π –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è –∏ –æ—Ç–∫—Ä—ã–≤–∞–π –∑–∞–∫—Ä—ã—Ç—ã–µ –∞–ø–≥—Ä–µ–π–¥—ã.</p>
        <p class="sub">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äú–¥–æ–Ω–∞—Ç‚Äù ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Å–∏–º—É–ª—è—Ü–∏—è (–∫–∞–∫ –≤ –æ–±—ã—á–Ω–æ–π –∏–≥—Ä–µ).</p>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">–ù–æ—Ç—ã</div>
          <div class="v" id="notes">0</div>
          <div class="s">–¢–≤–æ—è –≤–∞–ª—é—Ç–∞.</div>
        </div>
        <div class="stat">
          <div class="k">–ù–æ—Ç/–∫–ª–∏–∫</div>
          <div class="v" id="npc">1</div>
          <div class="s">–£—Å–∏–ª–µ–Ω–∏—è + –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è.</div>
        </div>
        <div class="stat">
          <div class="k">–ù–æ—Ç/—Å–µ–∫</div>
          <div class="v" id="nps">0</div>
          <div class="s">–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ —Å—Ç—É–¥–∏–∏.</div>
        </div>
        <div class="stat">
          <div class="k">–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è</div>
          <div class="v" id="reb">0</div>
          <div class="s">–û—Ç–∫—Ä—ã–≤–∞—é—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card clickZone">
        <h2>–°—Ç—É–¥–∏—è: —Å–¥–µ–ª–∞–π —Ö–∏—Ç</h2>

        <button class="bigBtn" id="clickBtn">
          <div class="inner">
            <div class="note">‚ô™</div>
            <div class="title">–ñ–ú–ò ‚Äî –ü–ò–®–ò –ù–û–¢–´</div>
            <div class="hint">
              –ö–∞–∂–¥—ã–π –∫–ª–∏–∫ –¥–∞—ë—Ç –Ω–æ—Ç—ã. –ü—Ä–æ–∫–∞—á–∞–π <b>–±–∏—Ç</b>, <b>–º–∏–∫—Ä–æ—Ñ–æ–Ω</b>, <b>—Å–≤–µ–¥–µ–Ω–∏–µ</b> –∏ –∑–∞–ø—É—Å—Ç–∏ <b>–∞–≤—Ç–æ-–¥–æ—Ö–æ–¥</b>.
              –ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—Ç—É–¥–∏—é, –Ω–æ –¥–∞—ë—Ç –º–æ—â–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å.
            </div>
          </div>
        </button>

        <div class="row">
          <button class="btn acc" id="openShop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
          <button class="btn good" id="openDonate">üíé –î–æ–Ω–∞—Ç</button>
          <button class="btn warn" id="openLog">üìú –°–æ–±—ã—Ç–∏—è</button>
          <button class="btn danger" id="hardReset">üß® –°–±—Ä–æ—Å</button>
        </div>

        <p class="sub" id="nextGoal">–°–ª–µ–¥—É—é—â–∞—è —Ü–µ–ª—å: ‚Äî</p>
      </div>

      <div class="card">
        <h2>–ë–∞–∑–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è</h2>
        <div class="list" id="basicList"></div>
      </div>

      <div class="card">
        <h2>–ó–∞–∫—Ä—ã—Ç—ã–µ —É–ª—É—á—à–µ–Ω–∏—è</h2>
        <div class="list" id="lockedList"></div>
        <p class="sub">–û—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π. –≠—Ç–æ —Ç–≤–æ–π –¥–æ–ª–≥–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å.</p>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalBg" id="modalBg" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="ttl" id="modalTitle">–ú–µ–Ω—é</div>
        <button class="btn" id="closeModal">‚úï</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFooter" id="modalFooter"></div>
    </div>
  </div>

  <!-- TOASTS -->
  <div class="toastHost" id="toastHost"></div>

<script>
(() => {
  // ===== Helpers =====
  const $ = (s) => document.querySelector(s);
  const fmt = (n) => {
    if (!isFinite(n)) return "‚àû";
    const abs = Math.abs(n);
    const units = [
      [1e12, "T"], [1e9, "B"], [1e6, "M"], [1e3, "K"]
    ];
    for (const [v,u] of units){
      if (abs >= v) return (n / v).toFixed(abs >= v*100 ? 0 : 2).replace(/\.?0+$/,"") + u;
    }
    return Math.floor(n).toString();
  };
  const now = () => Date.now();

  function toast(title, body=""){
    const host = $("#toastHost");
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = `<div class="t">${title}</div>${body ? `<div class="b">${body}</div>` : ""}`;
    host.appendChild(el);
    requestAnimationFrame(() => el.classList.add("show"));
    setTimeout(() => {
      el.classList.remove("show");
      setTimeout(() => el.remove(), 300);
    }, 2400);
  }

  function spark(x,y,text){
    const el = document.createElement("div");
    el.className = "spark";
    el.textContent = text;
    el.style.left = x + "px";
    el.style.top = y + "px";
    el.style.opacity = "1";
    el.style.transform = "translate(-50%, -50%) scale(1)";
    el.style.fontSize = (12 + Math.random()*6).toFixed(0) + "px";
    document.body.appendChild(el);

    const dx = (Math.random()*2-1) * 40;
    const dy = -70 - Math.random()*40;
    const t0 = performance.now();
    const dur = 650 + Math.random()*220;

    function tick(t){
      const p = Math.min(1, (t - t0) / dur);
      const ease = 1 - Math.pow(1-p, 3);
      el.style.transform = `translate(${dx*ease - 50}%, ${dy*ease - 50}%) scale(${1 - 0.15*ease})`;
      el.style.opacity = (1 - ease).toFixed(3);
      if (p < 1) requestAnimationFrame(tick);
      else el.remove();
    }
    requestAnimationFrame(tick);
  }

  // ===== Game Data =====
  const STORAGE_KEY = "notecraft_save_v1";

  const state = {
    notes: 0,
    rebirths: 0,
    // base mechanics
    clickBase: 1,
    clickMultFromRebirth: 1,    // grows with rebirths
    clickMultFromUpgrades: 1,
    npsBase: 0,
    npsMult: 1,
    // upgrade levels
    upgrades: {},     // id -> level
    lockedBought: {}, // id -> true/level
    // meta
    achievements: {},
    log: [],
    // donate currency
    gems: 0,
    donate: {
      moneyX2: false,
      rebirthX2: false,
      vipLuck: 0,   // 0..3
      offlineBoost: 0 // 0..3
    },
    lastTick: now(),
    lastSave: now(),
    lastEvent: 0
  };

  const BASIC_UPGRADES = [
    {
      id:"beat", name:"–ë–∏—Ç-–º–∞—à–∏–Ω–∞",
      desc:"–£—Å–∏–ª–∏–≤–∞–µ—Ç –Ω–æ—Ç—ã –∑–∞ –∫–ª–∏–∫.",
      baseCost: 15,
      costMul: 1.42,
      effect: (lvl)=> 1 + lvl*0.35, // multiplier to click
      tag:"–ö–ª–∏–∫"
    },
    {
      id:"mic", name:"–°—Ç—É–¥–∏–π–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω",
      desc:"–°–∏–ª—å–Ω–µ–µ –∫–ª–∏–∫–∏ + —á—É—Ç—å –±–æ–ª—å—à–µ —É–≤–∞–∂–µ–Ω–∏—è –∫ –∑–≤—É–∫—É.",
      baseCost: 60,
      costMul: 1.48,
      effect: (lvl)=> 1 + lvl*0.55,
      tag:"–ö–ª–∏–∫"
    },
    {
      id:"mix", name:"–°–≤–µ–¥–µ–Ω–∏–µ –∏ –º–∞—Å—Ç–µ—Ä–∏–Ω–≥",
      desc:"–£—Å–∫–æ—Ä—è–µ—Ç –∞–≤—Ç–æ-–¥–æ—Ö–æ–¥ (–Ω/—Å–µ–∫).",
      baseCost: 120,
      costMul: 1.45,
      effect: (lvl)=> 1 + lvl*0.40,
      tag:"–ù/—Å–µ–∫"
    },
    {
      id:"studio", name:"–ê—Ä–µ–Ω–¥–∞ —Å—Ç—É–¥–∏–∏",
      desc:"–î–∞—ë—Ç –±–∞–∑–æ–≤—ã–π –∞–≤—Ç–æ-–¥–æ—Ö–æ–¥.",
      baseCost: 90,
      costMul: 1.55,
      effect: (lvl)=> lvl * 2.2, // adds NPS base
      tag:"–ù/—Å–µ–∫"
    },
    {
      id:"promo", name:"–ü—Ä–æ–º–æ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö",
      desc:"–ß—É—Ç—å —É—Å–∏–ª–∏–≤–∞–µ—Ç –∏ –∫–ª–∏–∫–∏, –∏ –Ω/—Å–µ–∫.",
      baseCost: 250,
      costMul: 1.52,
      effect: (lvl)=> 1 + lvl*0.18,
      tag:"–ì–∏–±—Ä–∏–¥"
    },
  ];

  // Locked upgrades ‚Äì –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ —Ä–µ–±—ë—Ä—Å–∞–º –∏ –¥–∞—é—Ç –º–æ—â–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
  const LOCKED_UPGRADES = [
    {
      id:"label", name:"–ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å –ª–µ–π–±–ª–æ–º",
      reqReb: 2,
      desc:"–£–º–Ω–æ–∂–∞–µ—Ç –Ω/—Å–µ–∫. –≠—Ç–æ –ø–µ—Ä–≤—ã–π –±–æ–ª—å—à–æ–π –±—É—Å—Ç –ø–æ—Å–ª–µ —Ä–µ–±—ë—Ä—Å–æ–≤.",
      cost: 2500,
      once:true,
      apply: (s)=> { s.npsMult *= 2.2; }
    },
    {
      id:"ghostwriter", name:"–ì–æ—Å—Ç—Ä–∞–π—Ç–µ—Ä –≤ –∫–æ–º–∞–Ω–¥–µ",
      reqReb: 4,
      desc:"–£–º–Ω–æ–∂–∞–µ—Ç –Ω–æ—Ç—ã –∑–∞ –∫–ª–∏–∫. –ë—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑–≥–æ–Ω –¥–æ –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª.",
      cost: 12000,
      once:true,
      apply: (s)=> { s.clickMultFromUpgrades *= 2.0; }
    },
    {
      id:"tour", name:"–¢—É—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º",
      reqReb: 6,
      desc:"–°–∏–ª—å–Ω—ã–π –±—É—Å—Ç –∞–≤—Ç–æ-–¥–æ—Ö–æ–¥–∞ + —à–∞–Ω—Å —Å–æ–±—ã—Ç–∏–π –≤—ã—à–µ.",
      cost: 50000,
      once:true,
      apply: (s)=> { s.npsMult *= 2.8; s.donate.vipLuck = Math.max(s.donate.vipLuck, 1); }
    },
    {
      id:"platinum", name:"–ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π –∞–ª—å–±–æ–º",
      reqReb: 9,
      desc:"–ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å: –∫–ª–∏–∫–∏ –∏ –Ω/—Å–µ–∫ √ó2.5.",
      cost: 250000,
      once:true,
      apply: (s)=> { s.clickMultFromUpgrades *= 2.5; s.npsMult *= 2.5; }
    },
    {
      id:"arena", name:"–°—Ç–∞–¥–∏–æ–Ω–Ω—ã–π –∫–æ–Ω—Ü–µ—Ä—Ç",
      reqReb: 12,
      desc:"–û—Ç–∫—Ä—ã–≤–∞–µ—Ç ‚Äú—Ä–µ–∂–∏–º –ª–µ–≥–µ–Ω–¥—ã‚Äù: –∞–≤—Ç–æ-–¥–æ—Ö–æ–¥ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–æ–Ω—Å—Ç—Ä–æ–º.",
      cost: 1300000,
      once:true,
      apply: (s)=> { s.npsMult *= 4.0; }
    },
    {
      id:"halloffame", name:"–ó–∞–ª —Å–ª–∞–≤—ã",
      reqReb: 16,
      desc:"–ö–∞–∂–¥–æ–µ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ –¥–∞—ë—Ç –±–æ–ª—å—à–µ —Å–∏–ª—ã. (–£—Å–∏–ª–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º—É–ª—É —Ä–µ–±—ë—Ä—Å–∞.)",
      cost: 8500000,
      once:true,
      apply: (s)=> { s.__rebirthPowerBonus = (s.__rebirthPowerBonus||0) + 0.35; }
    }
  ];

  // Donate shop (—Å–∏–º—É–ª—è—Ü–∏—è)
  const DONATE_ITEMS = [
    {
      id:"gems_pack_s", name:"–ü–∞–∫ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ S",
      desc:"+50 üíé (–¥–ª—è —Ç–µ—Å—Ç–∞ / –±–µ–∑ –ø–ª–∞—Ç–µ–∂–µ–π)",
      priceGems: 0,
      buy: (s)=> { s.gems += 50; }
    },
    {
      id:"gems_pack_m", name:"–ü–∞–∫ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ M",
      desc:"+150 üíé",
      priceGems: 0,
      buy: (s)=> { s.gems += 150; }
    },
    {
      id:"moneyx2", name:"√ó2 –ù–æ—Ç—ã –Ω–∞–≤—Å–µ–≥–¥–∞",
      desc:"–í—Å—è –ø—Ä–∏–±—ã–ª—å (–∫–ª–∏–∫ –∏ –Ω/—Å–µ–∫) √ó2. –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–æ.",
      priceGems: 120,
      owned: (s)=> s.donate.moneyX2,
      buy: (s)=> { s.donate.moneyX2 = true; }
    },
    {
      id:"rebx2", name:"√ó2 –°–∏–ª–∞ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π",
      desc:"–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è –¥–∞—é—Ç –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ —É—Å–∏–ª–µ–Ω–∏—è.",
      priceGems: 160,
      owned: (s)=> s.donate.rebirthX2,
      buy: (s)=> { s.donate.rebirthX2 = true; }
    },
    {
      id:"luck1", name:"VIP-—É–¥–∞—á–∞ I",
      desc:"–ß—É—Ç—å —á–∞—â–µ –≤—ã–ø–∞–¥–∞—é—Ç —Å–æ–±—ã—Ç–∏—è –∏ –ø–æ–¥–∞—Ä–∫–∏ (–≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤—ã–µ).",
      priceGems: 80,
      owned: (s)=> s.donate.vipLuck >= 1,
      buy: (s)=> { s.donate.vipLuck = Math.max(s.donate.vipLuck, 1); }
    },
    {
      id:"luck2", name:"VIP-—É–¥–∞—á–∞ II",
      desc:"–ï—â—ë —á–∞—â–µ —Å–æ–±—ã—Ç–∏—è + –∏–Ω–æ–≥–¥–∞ –±–æ–Ω—É—Å–Ω—ã–µ üíé.",
      priceGems: 160,
      owned: (s)=> s.donate.vipLuck >= 2,
      buy: (s)=> { s.donate.vipLuck = Math.max(s.donate.vipLuck, 2); }
    },
    {
      id:"offline1", name:"–û—Ñ—Ñ–ª–∞–π–Ω –±—É—Å—Ç I",
      desc:"–ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –¥–∞—ë—Ç –±–æ–ª—å—à–µ –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–æ—Ö–æ–¥–∞.",
      priceGems: 90,
      owned: (s)=> s.donate.offlineBoost >= 1,
      buy: (s)=> { s.donate.offlineBoost = Math.max(s.donate.offlineBoost, 1); }
    },
    {
      id:"offline2", name:"–û—Ñ—Ñ–ª–∞–π–Ω –±—É—Å—Ç II",
      desc:"–ï—â—ë –±–æ–ª—å—à–µ –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–æ—Ö–æ–¥–∞.",
      priceGems: 170,
      owned: (s)=> s.donate.offlineBoost >= 2,
      buy: (s)=> { s.donate.offlineBoost = Math.max(s.donate.offlineBoost, 2); }
    },
  ];

  const ACH = [
    { id:"first_note", name:"–ü–µ—Ä–≤–∞—è –Ω–æ—Ç–∞", cond: s => s.notes >= 1, reward: () => ({gems: 5}) },
    { id:"k10", name:"–†–∞–∑–æ–≥—Ä–µ–≤", cond: s => s.notes >= 10_000, reward: () => ({gems: 10}) },
    { id:"m1", name:"–ü–µ—Ä–≤—ã–π –º–∏–ª–ª–∏–æ–Ω", cond: s => s.notes >= 1_000_000, reward: () => ({gems: 20}) },
    { id:"reb1", name:"–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ", cond: s => s.rebirths >= 1, reward: () => ({gems: 15}) },
    { id:"reb5", name:"–ü—è—Ç—å —Ü–∏–∫–ª–æ–≤", cond: s => s.rebirths >= 5, reward: () => ({gems: 25}) },
    { id:"vip", name:"VIP", cond: s => s.donate.moneyX2 || s.donate.rebirthX2 || s.donate.vipLuck>0, reward: () => ({gems: 10}) },
  ];

  // ===== Mechanics =====
  function getUpgradeLevel(id){ return state.upgrades[id] || 0; }
  function setUpgradeLevel(id, lvl){ state.upgrades[id] = lvl; }

  function computeClick(){
    // base
    let v = state.clickBase;

    // upgrade multipliers
    const beat = BASIC_UPGRADES.find(x=>x.id==="beat").effect(getUpgradeLevel("beat"));
    const mic  = BASIC_UPGRADES.find(x=>x.id==="mic").effect(getUpgradeLevel("mic"));
    const promo = BASIC_UPGRADES.find(x=>x.id==="promo").effect(getUpgradeLevel("promo"));

    v *= beat;
    v *= mic;
    v *= promo;

    // rebirth
    v *= state.clickMultFromRebirth;

    // locked & meta multipliers
    v *= state.clickMultFromUpgrades;

    // donate
    if (state.donate.moneyX2) v *= 2;

    return v;
  }

  function computeNPS(){
    const studio = BASIC_UPGRADES.find(x=>x.id==="studio").effect(getUpgradeLevel("studio")); // base NPS
    const mix = BASIC_UPGRADES.find(x=>x.id==="mix").effect(getUpgradeLevel("mix"));
    const promo = BASIC_UPGRADES.find(x=>x.id==="promo").effect(getUpgradeLevel("promo"));

    let v = 0;
    v += studio;
    v *= mix;
    v *= promo;

    v *= state.npsMult;
    if (state.donate.moneyX2) v *= 2;

    return v;
  }

  function upgradeCost(u){
    const lvl = getUpgradeLevel(u.id);
    return Math.floor(u.baseCost * Math.pow(u.costMul, lvl));
  }

  function nextRebirthRequirement(){
    // –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ç—ë—Ç –º—è–≥–∫–æ: –±–∞–∑–æ–≤–æ–µ + —ç–∫—Å–ø–æ–Ω–µ–Ω—Ç–∞ –ø–æ —Ä–µ–±—ë—Ä—Å–∞–º
    // –ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –¥–æ–ª–≥–æ: –¥–æ —Ä–µ–±—ë—Ä—Å–∞ –Ω–∞–¥–æ —Ä–∞–∑–æ–≥–Ω–∞—Ç—å—Å—è –ø–æ –Ω–æ—Ç–∞–º.
    const r = state.rebirths;
    const base = 25_000;
    const req = base * Math.pow(1.65, r);
    return Math.floor(req);
  }

  function rebirthGainMultiplier(){
    // –°–∏–ª–∞ —Ä–µ–±—ë—Ä—Å–∞: –∫–∞–∂–¥—ã–π —Ä–µ–±—ë—Ä—Å —É—Å–∏–ª–∏–≤–∞–µ—Ç –∫–ª–∏–∫–∏ (–∏ —á—É—Ç—å –Ω/—Å–µ–∫ –∫–æ—Å–≤–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ –±—ã—Å—Ç—Ä—ã–π —Ä–∞–∑–≥–æ–Ω)
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞
    let power = 1 + state.rebirths * 0.22;
    // "–ó–∞–ª —Å–ª–∞–≤—ã" —É—Å–∏–ª–∏–≤–∞–µ—Ç –ø—Ä–∏—Ä–æ—Å—Ç
    const bonus = state.__rebirthPowerBonus || 0;
    power *= (1 + bonus);

    // –î–æ–Ω–∞—Ç √ó2 —Å–∏–ª—ã —Ä–µ–±—ë—Ä—Å–∞
    if (state.donate.rebirthX2) power *= 2;

    return power;
  }

  function doRebirth(){
    const req = nextRebirthRequirement();
    if (state.notes < req){
      toast("–†–∞–Ω–æ –¥–ª—è –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è", `–ù—É–∂–Ω–æ ${fmt(req)} –Ω–æ—Ç.`);
      return;
    }

    state.rebirths += 1;

    // —É—Å–∏–ª–µ–Ω–∏–µ
    const gain = 1 + 0.40 + (state.rebirths * 0.06);
    // –∏—Ç–æ–≥–æ–≤—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å —Ä–µ–±—ë—Ä—Å–∞ = —Å—Ç–∞—Ä—ã–π √ó gain √ó "—Å–∏–ª—É —Ä–µ–±—ë—Ä—Å–∞"
    state.clickMultFromRebirth *= gain;
    state.clickMultFromRebirth *= (rebirthGainMultiplier() / Math.max(1, (state.rebirths-1)*0.22 + 1)); // –∞–∫–∫—É—Ä–∞—Ç–Ω–æ–µ –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ

    // –º–∞–ª–µ–Ω—å–∫–∞—è –Ω–∞–≥—Ä–∞–¥–∞
    const gemGift = Math.random() < (0.12 + state.donate.vipLuck*0.05) ? 10 : 0;
    if (gemGift) state.gems += gemGift;

    // reset —Å—Ç—É–¥–∏–∏
    state.notes = 0;
    state.npsBase = 0;
    state.npsMult = 1;
    state.clickMultFromUpgrades = state.clickMultFromUpgrades; // –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã–µ (–æ—Ç locked)
    state.upgrades = {};

    log(`‚ôªÔ∏è –ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ #${state.rebirths}. –£—Å–∏–ª–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –≤—ã—Ä–æ—Å–ª–æ. ${gemGift?`+${gemGift}üíé –ø–æ–¥–∞—Ä–æ–∫!`:''}`);
    toast("–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ!", `–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è ${state.rebirths} –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π. –£—Å–∏–ª–µ–Ω–∏–µ –∫ –∫–ª–∏–∫–∞–º –≤—ã—Ä–æ—Å–ª–æ.`);
    render();
    save();
  }

  // ===== Events (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–∫—É—á–Ω–æ) =====
  function maybeEvent(){
    const t = now();
    if (t - state.lastEvent < 10_000) return;

    const baseChance = 0.08; // —Ä–∞–∑ –≤ ~2 –º–∏–Ω —Å—Ä–µ–¥–Ω–µ–µ
    const chance = baseChance + state.donate.vipLuck*0.03 + Math.min(.08, state.rebirths*0.004);
    if (Math.random() > chance) return;

    state.lastEvent = t;

    const roll = Math.random();
    if (roll < 0.45){
      const bonus = Math.max(10, Math.floor(computeClick() * (25 + Math.random()*40)));
      state.notes += bonus;
      log(`üéÅ –°–æ–±—ã—Ç–∏–µ: ‚Äú–ó–∞—à—ë–ª –≤ —Ç—Ä–µ–Ω–¥—ã‚Äù ‚Äî +${fmt(bonus)} –Ω–æ—Ç!`);
      toast("–¢—ã –≤ —Ç—Ä–µ–Ω–¥–∞—Ö!", `+${fmt(bonus)} –Ω–æ—Ç`);
    } else if (roll < 0.78){
      const mult = 1.25 + Math.random()*0.45;
      const dur = 20_000;
      state.__tempClickBuff = { mult, until: t + dur };
      log(`‚ö° –°–æ–±—ã—Ç–∏–µ: ‚Äú–í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ‚Äù ‚Äî –∫–ª–∏–∫–∏ √ó${mult.toFixed(2)} –Ω–∞ 20 —Å–µ–∫`);
      toast("–í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ!", `–ö–ª–∏–∫–∏ √ó${mult.toFixed(2)} –Ω–∞ 20 —Å–µ–∫`);
    } else {
      const g = 5 + Math.floor(Math.random()*8) + state.donate.vipLuck*2;
      state.gems += g;
      log(`üíé –°–æ–±—ã—Ç–∏–µ: ‚Äú–§–∞–Ω–∞—Ç-–¥–æ–Ω–∞—Ç–µ—Ä‚Äù ‚Äî +${g}üíé`);
      toast("–§–∞–Ω–∞—Ç –∑–∞–¥–æ–Ω–∞—Ç–∏–ª!", `+${g}üíé`);
    }
  }

  function applyTempClickBuff(v){
    const b = state.__tempClickBuff;
    if (!b) return v;
    if (now() > b.until){ state.__tempClickBuff = null; return v; }
    return v * b.mult;
  }

  // ===== Achievements =====
  function checkAchievements(){
    for (const a of ACH){
      if (state.achievements[a.id]) continue;
      if (a.cond(state)){
        state.achievements[a.id] = true;
        const r = a.reward(state);
        if (r?.gems) state.gems += r.gems;
        log(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${a.name}. –ù–∞–≥—Ä–∞–¥–∞: ${r?.gems?`+${r.gems}üíé`:''}`);
        toast("–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!", `${a.name}${r?.gems?` ‚Ä¢ +${r.gems}üíé`:''}`);
      }
    }
  }

  function log(msg){
    state.log.unshift({ t: new Date().toLocaleString(), msg });
    state.log = state.log.slice(0, 80);
  }

  // ===== Save/Load + Offline =====
  function save(){
    state.lastSave = now();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    try{
      const obj = JSON.parse(raw);
      Object.assign(state, obj);
      return true;
    }catch(e){
      return false;
    }
  }

  function applyOfflineProgress(){
    const t = now();
    const dt = Math.max(0, (t - (state.lastTick || t)) / 1000);
    if (dt < 3) return;

    let offlineMul = 0.35; // –±–∞–∑–æ–≤–æ 35% –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ—Ñ—Ñ–ª–∞–π–Ω–∞
    offlineMul += state.donate.offlineBoost * 0.25; // –¥–æ +75%
    offlineMul = Math.min(1.0, offlineMul);

    const nps = computeNPS();
    const gain = nps * dt * offlineMul;

    if (gain > 0.5){
      state.notes += gain;
      log(`üïí –û—Ñ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥: +${fmt(gain)} –Ω–æ—Ç –∑–∞ ${Math.floor(dt)} —Å–µ–∫ (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ${Math.floor(offlineMul*100)}%).`);
      toast("–û—Ñ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥", `+${fmt(gain)} –Ω–æ—Ç`);
    }
  }

  // ===== UI Rendering =====
  function renderStats(){
    const click = applyTempClickBuff(computeClick());
    const nps = computeNPS();
    $("#notes").textContent = fmt(state.notes);
    $("#npc").textContent = fmt(click);
    $("#nps").textContent = fmt(nps);
    $("#reb").textContent = fmt(state.rebirths);

    const req = nextRebirthRequirement();
    const left = Math.max(0, req - state.notes);
    const goal = left <= 0
      ? `–ì–æ—Ç–æ–≤–æ –∫ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—é! –ù–∞–∂–º–∏ ‚Äú–ú–∞–≥–∞–∑–∏–Ω ‚Üí –ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ‚Äù.`
      : `–î–æ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è –Ω—É–∂–Ω–æ –µ—â—ë ${fmt(left)} –Ω–æ—Ç (—Ü–µ–ª—å: ${fmt(req)}).`;
    $("#nextGoal").textContent = goal;
  }

  function renderUpgrades(){
    const basic = $("#basicList");
    basic.innerHTML = "";
    for (const u of BASIC_UPGRADES){
      const lvl = getUpgradeLevel(u.id);
      const cost = upgradeCost(u);
      const can = state.notes >= cost;
      const eff = u.effect(lvl+1);

      const meta = (u.tag === "–ù/—Å–µ–∫")
        ? `–°–ª–µ–¥. —ç—Ñ—Ñ–µ–∫—Ç: √ó${eff.toFixed(2)} –∫ –Ω/—Å–µ–∫`
        : (u.tag === "–ö–ª–∏–∫")
          ? `–°–ª–µ–¥. —ç—Ñ—Ñ–µ–∫—Ç: √ó${eff.toFixed(2)} –∫ –∫–ª–∏–∫—É`
          : `–°–ª–µ–¥. —ç—Ñ—Ñ–µ–∫—Ç: √ó${eff.toFixed(2)} –∫ –∫–ª–∏–∫—É –∏ –Ω/—Å–µ–∫`;

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div class="name">${u.name} <span class="tag">${u.tag}</span></div>
          <div class="desc">${u.desc}</div>
          <div class="meta">
            <span class="tag">–£—Ä. ${lvl}</span>
            <span class="tag">–¶–µ–Ω–∞: ${fmt(cost)} ‚ô™</span>
          </div>
        </div>
        <div>
          <button class="btn ${can?'good':''}" ${can?'':'disabled'} data-buy="${u.id}">
            –ö—É–ø–∏—Ç—å
          </button>
        </div>
      `;
      el.querySelector("[data-buy]").addEventListener("click", () => {
        if (state.notes < cost) return;
        state.notes -= cost;
        setUpgradeLevel(u.id, lvl+1);
        log(`üõ†Ô∏è –ö—É–ø–ª–µ–Ω–æ: ${u.name} (—É—Ä. ${lvl+1})`);
        render();
        save();
      });
      basic.appendChild(el);
    }

    const locked = $("#lockedList");
    locked.innerHTML = "";
    for (const u of LOCKED_UPGRADES){
      const owned = !!state.lockedBought[u.id];
      const unlocked = state.rebirths >= u.reqReb;
      const can = unlocked && !owned && state.notes >= u.cost;

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div class="name">${u.name}
            ${owned ? `<span class="tag vip">–ö—É–ø–ª–µ–Ω–æ</span>` : unlocked ? `<span class="tag reb">–û—Ç–∫—Ä—ã—Ç–æ</span>` : `<span class="tag lock">–ó–∞–∫—Ä—ã—Ç–æ</span>`}
          </div>
          <div class="desc">${u.desc}</div>
          <div class="meta">
            <span class="tag">–¢—Ä–µ–±.: ${u.reqReb} —Ä–µ–±.</span>
            <span class="tag">–¶–µ–Ω–∞: ${fmt(u.cost)} ‚ô™</span>
          </div>
        </div>
        <div>
          <button class="btn ${can?'acc':''}" ${can?'':'disabled'} data-locked="${u.id}">
            ${owned ? "–ï—Å—Ç—å" : unlocked ? "–ö—É–ø–∏—Ç—å" : "–ù—É–∂–Ω–æ —Ä–µ–±."}
          </button>
        </div>
      `;
      el.querySelector("[data-locked]").addEventListener("click", () => {
        if (!unlocked || owned || state.notes < u.cost) return;
        state.notes -= u.cost;
        state.lockedBought[u.id] = true;
        u.apply(state);
        log(`üîì –ö—É–ø–ª–µ–Ω–æ (–∑–∞–∫—Ä—ã—Ç–æ–µ): ${u.name}`);
        toast("–û—Ç–∫—Ä—ã—Ç–æ!", `${u.name}`);
        render();
        save();
      });
      locked.appendChild(el);
    }
  }

  function render(){
    renderStats();
    renderUpgrades();
    checkAchievements();
  }

  // ===== Modal System =====
  const modalBg = $("#modalBg");
  const modalTitle = $("#modalTitle");
  const modalBody = $("#modalBody");
  const modalFooter = $("#modalFooter");

  function openModal(title, bodyNodes, footerNodes){
    modalTitle.textContent = title;
    modalBody.innerHTML = "";
    modalFooter.innerHTML = "";
    bodyNodes.forEach(n => modalBody.appendChild(n));
    footerNodes.forEach(n => modalFooter.appendChild(n));
    modalBg.style.display = "flex";
  }
  function closeModal(){
    modalBg.style.display = "none";
  }
  $("#closeModal").addEventListener("click", closeModal);
  modalBg.addEventListener("click", (e)=>{ if (e.target === modalBg) closeModal(); });

  function cardNode(title, desc, tags=[]){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<h2>${title}</h2><div class="mini">${desc}</div>`;
    if (tags.length){
      const row = document.createElement("div");
      row.className = "pillRow";
      tags.forEach(t => {
        const sp = document.createElement("span");
        sp.className = "tag";
        sp.textContent = t;
        row.appendChild(sp);
      });
      wrap.appendChild(row);
    }
    return wrap;
  }

  function openShopModal(){
    const left = document.createElement("div");
    left.className = "card";
    left.innerHTML = `
      <h2>–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ</h2>
      <div class="mini">
        –ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—Ç—É–¥–∏—é (–±–∞–∑–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –∏ –Ω–æ—Ç—ã),
        –Ω–æ –¥–∞—ë—Ç –º–æ—â–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç: <b>—É—Å–∏–ª–µ–Ω–∏–µ –∫ –∫–ª–∏–∫–∞–º</b> –∏ –¥–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç—ã–º –∞–ø–≥—Ä–µ–π–¥–∞–º.
        <br><br>
        –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ —Å–µ–π—á–∞—Å: <b>${fmt(nextRebirthRequirement())} ‚ô™</b>
      </div>
      <div class="pillRow">
        <span class="tag">–¢–≤–æ–∏ —Ä–µ–±.: ${state.rebirths}</span>
        <span class="tag">–°–∏–ª–∞ —Ä–µ–±—ë—Ä—Å–∞: √ó${rebirthGainMultiplier().toFixed(2)}</span>
        ${state.donate.rebirthX2 ? `<span class="tag vip">donate √ó2 reb</span>` : ``}
      </div>
    `;

    const right = document.createElement("div");
    right.className = "card";
    right.innerHTML = `
      <h2>–î–æ–ø. –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>
      <div class="mini">
        –¢—É—Ç ‚Äú–¥–æ–ª–≥–∏–π –≥–µ–π–º–ø–ª–µ–π‚Äù: –∑–∞–∫—Ä—ã—Ç—ã–µ —É–ª—É—á—à–µ–Ω–∏—è, —Å–æ–±—ã—Ç–∏—è, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–æ—Ö–æ–¥.
        –ß–µ–º –±–æ–ª—å—à–µ —Ä–µ–±—ë—Ä—Å–æ–≤ ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑–≥–æ–Ω.
      </div>
      <div class="pillRow">
        <span class="tag">üíé: ${state.gems}</span>
        <span class="tag">VIP luck: ${state.donate.vipLuck}</span>
        <span class="tag">offline: ${state.donate.offlineBoost}</span>
      </div>
    `;

    const rebBtn = document.createElement("button");
    rebBtn.className = "btn danger";
    rebBtn.textContent = "‚ôªÔ∏è –°–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ";
    rebBtn.disabled = state.notes < nextRebirthRequirement();
    rebBtn.addEventListener("click", () => { closeModal(); doRebirth(); });

    const infoBtn = document.createElement("button");
    infoBtn.className = "btn";
    infoBtn.textContent = "üìò –ö–∞–∫ –∏–≥—Ä–∞—Ç—å";
    infoBtn.addEventListener("click", () => {
      closeModal();
      openModal("–ö–∞–∫ –∏–≥—Ä–∞—Ç—å",
        [
          cardNode("–°—É—Ç—å", "–ö–ª–∏–∫–∞–π ‚ô™ ‚Üí –ø–æ–∫—É–ø–∞–π –±–∞–∑–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è ‚Üí —Ä–∞–∑–≥–æ–Ω—è–π –∞–≤—Ç–æ-–¥–æ—Ö–æ–¥ ‚Üí –¥–µ–ª–∞–π –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–π –∑–∞–∫—Ä—ã—Ç—ã–µ —É–ª—É—á—à–µ–Ω–∏—è. –≠—Ç–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ª–µ—Å—Ç–Ω–∏—Ü–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞."),
          cardNode("–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏—è", "–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–æ—Ç—ã –∏ –±–∞–∑–æ–≤—ã–µ –∞–ø–≥—Ä–µ–π–¥—ã, –Ω–æ —É—Å–∏–ª–∏–≤–∞–µ—Ç –∫–ª–∏–∫–∏ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ—â–Ω—ã–µ –∞–ø–≥—Ä–µ–π–¥—ã –ø–æ –∫–æ–ª-–≤—É —Ä–µ–±—ë—Ä—Å–æ–≤. –¶–µ–ª—å ‚Äî –¥–µ–ª–∞—Ç—å —Ä–µ–±—ë—Ä—Å—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ –∏ —É—Å–∏–ª–∏–≤–∞—Ç—å ‚Äú–º–µ—Ç—É‚Äù."),
          cardNode("–°–æ–±—ã—Ç–∏—è / –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è", "–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–ª—É—á–∞—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è: —Ç—Ä–µ–Ω–¥—ã, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, —Ñ–∞–Ω–∞—Ç—ã. –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –¥–∞—é—Ç üíé.", ["–°–æ–±—ã—Ç–∏—è", "–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è", "üíé"]),
          cardNode("–î–æ–Ω–∞—Ç (—Å–∏–º—É–ª—è—Ü–∏—è)", "–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–æ–π –º–∞–≥–∞–∑–∏–Ω, —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∫—É: √ó2 –Ω–æ—Ç—ã, √ó2 —Å–∏–ª–∞ —Ä–µ–±—ë—Ä—Å–∞, —É–¥–∞—á–∞, –æ—Ñ—Ñ–ª–∞–π–Ω –±—É—Å—Ç.")
        ],
        [mkCloseBtn("–û–∫")]
      );
    });

    openModal("–ú–∞–≥–∞–∑–∏–Ω",
      [left, right],
      [infoBtn, rebBtn, mkCloseBtn("–ó–∞–∫—Ä—ã—Ç—å")]
    );
  }

  function mkCloseBtn(txt){
    const b = document.createElement("button");
    b.className = "btn";
    b.textContent = txt;
    b.addEventListener("click", closeModal);
    return b;
  }

  function openDonateModal(){
    const left = document.createElement("div");
    left.className = "card";
    left.innerHTML = `
      <h2>üíé –î–æ–Ω–∞—Ç-–º–∞–≥–∞–∑–∏–Ω (—Å–∏–º—É–ª—è—Ü–∏—è)</h2>
      <div class="mini">
        –ó–¥–µ—Å—å –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π. –≠—Ç–æ ‚Äú–∫–∞–∫ –±—É–¥—Ç–æ –¥–æ–Ω–∞—Ç‚Äù, —á—Ç–æ–±—ã –º–µ—Ö–∞–Ω–∏–∫–∞ –±—ã–ª–∞ –∫–∞–∫ –≤ –Ω–∞—Å—Ç–æ—è—â–∏—Ö –∏–≥—Ä–∞—Ö.
        <br><br>
        –¢–≤–æ–∏ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã: <b>${state.gems} üíé</b>
      </div>
    `;

    const list = document.createElement("div");
    list.className = "card";
    list.innerHTML = `<h2>–¢–æ–≤–∞—Ä—ã</h2>`;
    const box = document.createElement("div");
    box.className = "list";
    list.appendChild(box);

    for (const it of DONATE_ITEMS){
      const owned = it.owned ? it.owned(state) : false;
      const price = it.priceGems || 0;
      const can = !owned && state.gems >= price;

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <div class="name">${it.name} ${owned?`<span class="tag vip">–£–∂–µ –µ—Å—Ç—å</span>`:""}</div>
          <div class="desc">${it.desc}</div>
          <div class="meta">
            <span class="tag">–¶–µ–Ω–∞: ${price} üíé</span>
          </div>
        </div>
        <div>
          <button class="btn ${can?'good':''}" ${can?'':'disabled'}>–ö—É–ø–∏—Ç—å</button>
        </div>
      `;
      el.querySelector("button").addEventListener("click", () => {
        if (owned) return;
        if (price > 0 && state.gems < price) return;
        state.gems -= price;
        it.buy(state);
        log(`üíé –î–æ–Ω–∞—Ç: ${it.name}`);
        toast("–ö—É–ø–ª–µ–Ω–æ", it.name);
        closeModal();
        render();
        save();
        openDonateModal();
      });
      box.appendChild(el);
    }

    openModal("–î–æ–Ω–∞—Ç",
      [left, list],
      [mkCloseBtn("–ó–∞–∫—Ä—ã—Ç—å")]
    );
  }

  function openLogModal(){
    const left = document.createElement("div");
    left.className = "card";
    left.innerHTML = `
      <h2>üìú –°–æ–±—ã—Ç–∏—è</h2>
      <div class="mini">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∏ –ø–æ–∫—É–ø–∫–∏ (—Ö—Ä–∞–Ω–∏—Ç—Å—è –¥–æ 80 –∑–∞–ø–∏—Å–µ–π).</div>
    `;

    const right = document.createElement("div");
    right.className = "card";
    right.innerHTML = `<h2>–õ–µ–Ω—Ç–∞</h2>`;
    const box = document.createElement("div");
    box.className = "list";
    right.appendChild(box);

    if (!state.log.length){
      const empty = document.createElement("div");
      empty.className = "mini";
      empty.textContent = "–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ö–ª–∏–∫–Ω–∏ –ø–∞—Ä—É —Ä–∞–∑ –∏ –∫—É–ø–∏ –∞–ø–≥—Ä–µ–π–¥.";
      box.appendChild(empty);
    } else {
      for (const l of state.log){
        const it = document.createElement("div");
        it.className = "item";
        it.innerHTML = `
          <div>
            <div class="name">${l.msg}</div>
            <div class="desc">${l.t}</div>
          </div>
          <div><span class="tag">LOG</span></div>
        `;
        box.appendChild(it);
      }
    }

    openModal("–°–æ–±—ã—Ç–∏—è",
      [left, right],
      [
        mkBtn("üßΩ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥", "btn warn", () => { state.log = []; closeModal(); openLogModal(); save(); }),
        mkCloseBtn("–ó–∞–∫—Ä—ã—Ç—å")
      ]
    );
  }

  function mkBtn(txt, cls, fn){
    const b = document.createElement("button");
    b.className = cls || "btn";
    b.textContent = txt;
    b.addEventListener("click", fn);
    return b;
  }

  // ===== Controls =====
  $("#openShop").addEventListener("click", openShopModal);
  $("#openDonate").addEventListener("click", openDonateModal);
  $("#openLog").addEventListener("click", openLogModal);

  $("#hardReset").addEventListener("click", () => {
    const ok = confirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.");
    if (!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  });

  $("#clickBtn").addEventListener("click", (e) => {
    const click = applyTempClickBuff(computeClick());
    state.notes += click;

    // spark
    const rect = e.currentTarget.getBoundingClientRect();
    const x = rect.left + rect.width/2 + (Math.random()*2-1)*60;
    const y = rect.top + rect.height/2 + (Math.random()*2-1)*30;
    spark(x, y, `+${fmt(click)}‚ô™`);

    maybeEvent();
    renderStats(); // –±—ã—Å—Ç—Ä–æ
  });

  // ===== Main Loop =====
  function tick(){
    const t = now();
    const dt = (t - state.lastTick) / 1000;
    state.lastTick = t;

    const nps = computeNPS();
    if (nps > 0){
      state.notes += nps * dt;
    }

    maybeEvent();
    checkAchievements();
    renderStats();

    if (t - state.lastSave > 2500){
      save();
    }
    requestAnimationFrame(tick);
  }

  // ===== Boot =====
  const loaded = load();
  if (!loaded){
    state.notes = 0;
    state.rebirths = 0;
    state.log = [];
    state.gems = 0;
    log("üéõÔ∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ NOTECRAFT. –ö–ª–∏–∫–∞–µ–º ‚ô™ –∏ —Å—Ç—Ä–æ–∏–º –∏–º–ø–µ—Ä–∏—é.");
    toast("NOTECRAFT", "–ñ–º–∏ ‚ô™ –∏ –ø–æ–∫—É–ø–∞–π —É–ª—É—á—à–µ–Ω–∏—è.");
  } else {
    applyOfflineProgress();
    toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ", "–ü—Ä–æ–≥—Ä–µ—Å—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
  }

  // –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
  render();
  // —Å—Ç–∞—Ä—Ç
  requestAnimationFrame(() => {
    state.lastTick = now();
    tick();
  });

})();
</script>
</body>
            </html>
