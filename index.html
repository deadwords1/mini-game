<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Ball Blast Mobile ‚Äî Long Progress</title>
  <style>
    :root{
      --shadow: rgba(0,0,0,.22);
      --glass: rgba(255,255,255,.70);
      --glass2: rgba(255,255,255,.86);
      --border: rgba(255,255,255,.95);
      --text: rgba(0,0,0,.82);
      --muted: rgba(0,0,0,.58);
      --blue: #2EC4FF;
      --gold: #FFC43A;
      --gem: #8E5BFF;
      --good:#37D17A;
      --bad:#FF4A6B;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;overflow:hidden;background:#87CEFA;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{position:fixed;inset:0;touch-action:none;}
    canvas{width:100%;height:100%;display:block;touch-action:none}

    /* HUD */
    .hud{
      position:absolute; left:0; right:0; top:0;
      padding: max(10px, env(safe-area-inset-top)) 10px 0 10px;
      display:flex; justify-content:space-between; gap:10px;
      pointer-events:none;
      z-index:10;
    }
    .bar{
      pointer-events:none;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:8px 10px;
      border-radius:14px;
      background: var(--glass);
      border:1px solid var(--border);
      box-shadow: 0 14px 40px var(--shadow);
      font-weight:1000;
      backdrop-filter: blur(7px);
      color:var(--text);
    }
    .btns{display:flex; gap:8px; pointer-events:auto; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      height:40px;
      padding:0 12px;
      border-radius:14px;
      background: var(--glass);
      border:1px solid var(--border);
      box-shadow: 0 14px 40px var(--shadow);
      font-weight:1000;
      display:flex; align-items:center; gap:8px;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      cursor:pointer;
      color:var(--text);
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px); filter:brightness(.96)}
    .dot{width:9px;height:9px;border-radius:50%;background:var(--blue);box-shadow:0 0 10px rgba(46,196,255,.7)}
    .dot.p{background:var(--gem);box-shadow:0 0 10px rgba(142,91,255,.6)}
    .dot.g{background:var(--good);box-shadow:0 0 10px rgba(55,209,122,.6)}
    .dot.r{background:var(--bad);box-shadow:0 0 10px rgba(255,74,107,.6)}

    /* Chips */
    .chips{
      position:absolute;
      right:10px;
      top: calc(58px + max(10px, env(safe-area-inset-top)));
      display:flex;
      gap:8px;
      z-index:11;
      pointer-events:none;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(255,255,255,.95);
      box-shadow: 0 14px 40px var(--shadow);
      font-weight:1000;
      font-size:12px;
      display:none;
      align-items:center;
      gap:6px;
      color:var(--text);
      backdrop-filter: blur(7px);
    }
    .chip.on{display:inline-flex}

    /* Toast */
    .toast{
      position:absolute; left:50%;
      bottom: max(10px, env(safe-area-inset-bottom));
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.45);
      color: rgba(255,255,255,.95);
      font-weight:900;
      font-size:13px;
      opacity:0;
      transition:.16s opacity ease;
      pointer-events:none;
      z-index:30;
      max-width: calc(100% - 20px);
      text-align:center;
    }
    .toast.on{opacity:1}

    /* Banner */
    .banner{
      position:absolute;
      left:50%;
      top: calc(58px + max(10px, env(safe-area-inset-top)));
      transform:translateX(-50%);
      padding:10px 14px;
      border-radius:999px;
      background: rgba(255,255,255,.90);
      border:1px solid rgba(255,255,255,.95);
      box-shadow: 0 16px 55px rgba(0,0,0,.20);
      font-weight:1000;
      opacity:0;
      pointer-events:none;
      z-index:20;
      backdrop-filter: blur(8px);
      color:var(--text);
    }
    .banner.on{animation:pop 1.2s ease forwards;}
    @keyframes pop{
      0%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.92)}
      20%{opacity:1; transform:translateX(-50%) translateY(0) scale(1.02)}
      60%{opacity:1; transform:translateX(-50%) translateY(0) scale(1)}
      100%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.96)}
    }

    /* Start overlay */
    .start{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.16);
      backdrop-filter: blur(5px);
      z-index:40;
    }
    .card{
      width:min(560px,100%);
      border-radius:18px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.95);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      padding:14px;
      text-align:center;
      color:var(--text);
    }
    .card h1{margin:8px 0 8px;font-size:18px}
    .card p{margin:0 0 12px;color:rgba(0,0,0,.62);font-weight:800;font-size:13px;line-height:1.35}
    .bigRow{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
    .big{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 14px;
      border-radius:14px;
      background: var(--blue);
      color:white;
      font-weight:1000;
      border:0;
      box-shadow: 0 10px 25px rgba(0,0,0,.20);
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      min-width: 140px;
    }
    .big:active{transform:translateY(1px); filter:brightness(.96)}
    .big.secondary{background: rgba(0,0,0,.10); color: rgba(0,0,0,.88); border:1px solid rgba(0,0,0,.10); box-shadow:none}

    /* Modals */
    .modal{
      position:absolute; inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:10px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      z-index:60;
    }
    .modal.on{display:flex}

    .sheet{
      width:min(980px,100%);
      max-height: calc(100% - max(18px, env(safe-area-inset-top)));
      overflow:hidden;
      border-radius:20px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.95);
      box-shadow: 0 18px 70px rgba(0,0,0,.28);
      display:flex; flex-direction:column;
    }
    .sheetTop{
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid rgba(0,0,0,.08);
      color:var(--text);
    }
    .sheetTop h2{margin:0;font-size:16px}
    .muted{color:rgba(0,0,0,.58);font-weight:800;font-size:12.5px;line-height:1.35}
    .tag{
      display:inline-flex; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.10);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .sheetBody{padding:12px 14px 14px; overflow:auto; -webkit-overflow-scrolling:touch}

    /* Bottom tabs like original (but inside modal) */
    .tabsBottom{
      display:flex;
      gap:10px;
      padding:10px;
      border-top:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.92);
    }
    .tabBtn{
      flex:1;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.04);
      font-weight:1000;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      color:var(--text);
    }
    .tabBtn.on{background: var(--blue); color:white; border-color: rgba(0,0,0,0)}
    .tabBtn:active{transform:translateY(1px); filter:brightness(.96)}

    /* Horizontal cards (scroll sideways) */
    .rail{
      display:flex;
      gap:12px;
      overflow-x:auto;
      overflow-y:hidden;
      padding:6px 2px 10px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling:touch;
    }
    .rail::-webkit-scrollbar{height:0}
    .cardItem{
      flex:0 0 min(320px, 85vw);
      scroll-snap-align: start;
      padding:12px;
      border-radius:16px;
      background: rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.08);
      display:flex;
      flex-direction:column;
      gap:8px;
      color:var(--text);
      position:relative;
    }
    .headRow{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .name{font-weight:1000}
    .price{font-weight:1000; color:#b06b00}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap}
    .mini{
      padding:10px 12px;
      border-radius:14px;
      background: var(--good);
      color:white;
      font-weight:1000;
      border:0;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .mini:active{transform:translateY(1px); filter:brightness(.96)}
    .mini:disabled{opacity:.45; cursor:not-allowed; box-shadow:none}
    .mini.purple{background: var(--gem)}
    .mini.gray{background: var(--blue)}
    .mini.red{background: var(--bad)}
    .rar{
      padding:4px 8px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.75);
      white-space:nowrap;
    }
    .rar.common{color:#222}
    .rar.uncommon{color:#0B6E8D}
    .rar.rare{color:#3C2AAE}
    .rar.legendary{color:#9A6A00}
    .rar.mythic{color:#5C1FB4}

    /* Chest UI */
    .chestWrap{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;text-align:center}
    .chestArea{width:min(360px,100%);height:220px;display:flex;align-items:center;justify-content:center;position:relative}
    .chest{
      width:170px;height:128px;border-radius:20px;
      background: linear-gradient(180deg, rgba(255,196,58,.95), rgba(226,146,21,.95));
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 18px 70px rgba(0,0,0,.25);
      position:relative;
      transform:translateY(0) scale(1);
      transition: transform .16s ease, filter .16s ease;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .chest:active{transform:translateY(2px) scale(.99); filter:brightness(.96)}
    .chest:before{content:"";position:absolute;left:12px;right:12px;top:52px;height:10px;border-radius:999px;background: rgba(0,0,0,.18);}
    .lock{
      position:absolute;width:36px;height:36px;left:50%;top:46px;transform:translateX(-50%);
      border-radius:12px;background: rgba(255,255,255,.85);border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      display:flex;align-items:center;justify-content:center;font-weight:1000;
    }
    .shine{
      position:absolute;inset:-10px;border-radius:28px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.55), transparent 50%),
                  radial-gradient(circle at 70% 50%, rgba(255,255,255,.25), transparent 55%);
      pointer-events:none;opacity:.8;
    }
    .openAnim{animation: chestOpen .8s ease forwards;}
    @keyframes chestOpen{
      0%{transform:translateY(0) scale(1)}
      30%{transform:translateY(-6px) scale(1.04)}
      55%{transform:translateY(0) scale(1.02)}
      100%{transform:translateY(0) scale(1)}
    }

    input[type="number"], input[type="password"]{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      font-weight:1000;
      background:rgba(255,255,255,.92);
      outline:none;
      color:var(--text);
    }

    /* Small preview */
    .previewGun{
      height:62px;
      border-radius:14px;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.95);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .badge{
      position:absolute;
      right:10px;
      top:10px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(0,0,0,.08);
      border:1px solid rgba(0,0,0,.10);
      font-weight:1000;
      font-size:12px;
      color:var(--text);
    }
  </style>
</head>
<body>
<div class="wrap">
  <canvas id="c"></canvas>

  <div class="hud">
    <div class="bar">
      <span>Stage <span id="uiStage">1</span></span>
      <span>LvL <span id="uiWave">1</span>/<span id="uiWaveInStage">5</span></span>
      <span>ü™ô <span id="uiCoins">0</span></span>
      <span>üíé <span id="uiGems">0</span></span>
      <span>üèÜ <span id="uiBest">0</span></span>
    </div>
    <div class="btns">
      <div class="btn" id="btnShop"><span class="dot"></span>Shop</div>
      <div class="btn" id="btnPets"><span class="dot p"></span>Pets</div>
      <div class="btn" id="btnAdmin"><span class="dot.r dot r"></span>Admin</div>
      <div class="btn" id="btnPause"><span class="dot g"></span>‚è∏</div>
    </div>
  </div>

  <div class="chips">
    <div class="chip" id="chipShield">üõ° –©–∏—Ç</div>
    <div class="chip" id="chipFrenzy">‚ö° –§—Ä–µ–Ω–∑–∏ <span id="chipFrenzyT">0</span>s</div>
  </div>

  <div class="banner" id="banner">‚Äî</div>
  <div class="toast" id="toast"></div>

  <div class="start" id="start">
    <div class="card">
      <div style="font-weight:1000; color:rgba(0,0,0,.70)">Ball Blast Mobile ‚Äî Long Progress</div>
      <h1 id="startTitle">–ó–∞–∂–∞–ª ‚Üí –≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º</h1>
      <p id="startDesc">–≠—Ç–∞–ø = 5 —É—Ä–æ–≤–Ω–µ–π. –ö–∞–∂–¥—ã–π 5-–π —ç—Ç–∞–ø ‚Äî –ë–û–°–°. –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</p>
      <div class="bigRow">
        <button class="big" id="btnContinue">‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        <button class="big" id="btnStart">‚ñ∂ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        <button class="big secondary" id="btnReset">‚Ü∫ –°–±—Ä–æ—Å</button>
      </div>
      <p style="margin-top:10px;font-size:12px;opacity:.85">–°—É–Ω–¥—É–∫ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ üéÅ</p>
    </div>
  </div>

  <!-- SHOP (new layout with bottom tabs + horizontal rails) -->
  <div class="modal" id="mShop">
    <div class="sheet">
      <div class="sheetTop">
        <div>
          <h2>Shop</h2>
          <div class="muted" id="shopSubtitle">–ü—Ä–æ–∫–∞—á–∫–∞ / –æ—Ä—É–∂–∏–µ / –∫–æ—Å–º–µ—Ç–∏–∫–∞ ‚Äî –ª–∏—Å—Ç–∞–π –≤–ø—Ä–∞–≤–æ</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <div class="tag">ü™ô <span id="uiCoins2">0</span></div>
          <div class="tag">üíé <span id="uiGems2">0</span></div>
          <div class="btn" id="closeShop"><span class="dot"></span>–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
      </div>

      <div class="sheetBody">
        <div id="shopUpgrades" class="rail"></div>
        <div id="shopWeapons" class="rail" style="display:none"></div>
        <div id="shopCosmetics" class="rail" style="display:none"></div>
      </div>

      <div class="tabsBottom">
        <button class="tabBtn on" id="tabUp">–ü—Ä–æ–∫–∞—á–∫–∞</button>
        <button class="tabBtn" id="tabWp">–û—Ä—É–∂–∏–µ</button>
        <button class="tabBtn" id="tabCs">–ö–æ—Å–º–µ—Ç–∏–∫–∞</button>
      </div>
    </div>
  </div>

  <!-- PETS -->
  <div class="modal" id="mPets">
    <div class="sheet">
      <div class="sheetTop">
        <div>
          <h2>Pets</h2>
          <div class="muted">–†—É–ª–µ—Ç–∫–∞ –∑–∞ üíé. –ü–∏—Ç–æ–º—Ü—ã –±–∞—Ñ–∞—é—Ç —É—Ä–æ–Ω + –º–æ–Ω–µ—Ç—ã.</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <div class="tag">üíé <span id="uiGems3">0</span></div>
          <div class="btn" id="closePets"><span class="dot p"></span>–ó–∞–∫—Ä—ã—Ç—å</div>
        </div>
      </div>

      <div class="sheetBody">
        <div class="cardItem" style="flex:1; max-width:100%">
          <div class="headRow">
            <div>
              <div class="name">–¢–µ–∫—É—â–∏–π –ø–∏—Ç–æ–º–µ—Ü: <span id="activePetName">‚Äî</span></div>
              <div class="muted">–ë–∞—Ñ—ã: <b>–£—Ä–æ–Ω</b> <span id="petDmg">0%</span> ‚Ä¢ <b>–ú–æ–Ω–µ—Ç—ã</b> <span id="petCoin">0%</span></div>
            </div>
            <div><span class="rar" id="activePetRar">‚Äî</span></div>
          </div>

          <div class="muted">–®–∞–Ω—Å—ã: Common 60% ‚Ä¢ Uncommon 22% ‚Ä¢ Rare 12% ‚Ä¢ Legendary 5% ‚Ä¢ Mythic 1%</div>
          <div class="row">
            <button class="mini purple" id="spin1">–ö—Ä—É—Ç–∏—Ç—å x1 (üíé 25)</button>
            <button class="mini purple" id="spin10">–ö—Ä—É—Ç–∏—Ç—å x10 (üíé 220)</button>
          </div>

          <div style="height:8px"></div>
          <div class="name">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
          <div id="invGrid" class="rail" style="padding-top:4px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="modal" id="mAdmin">
    <div class="sheet">
      <div class="sheetTop">
        <div>
          <h2>Admin</h2>
          <div class="muted">–ß–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ. –ü–∞—Ä–æ–ª—å: <b>112</b></div>
        </div>
        <div class="btn" id="closeAdmin"><span class="dot r"></span>–ó–∞–∫—Ä—ã—Ç—å</div>
      </div>
      <div class="sheetBody">
        <div class="cardItem" style="flex:1; max-width:100%">
          <div class="name">–ü–∞—Ä–æ–ª—å</div>
          <input id="adminPass" type="password" placeholder="112" />
          <div style="height:10px"></div>

          <div class="row">
            <div style="flex:1">
              <div class="muted">–í—ã–¥–∞—Ç—å ü™ô</div>
              <input id="giveCoins" type="number" inputmode="numeric" value="5000" />
            </div>
            <button class="mini" id="btnGiveCoins">+ü™ô</button>
          </div>

          <div class="row">
            <div style="flex:1">
              <div class="muted">–í—ã–¥–∞—Ç—å üíé</div>
              <input id="giveGems" type="number" inputmode="numeric" value="500" />
            </div>
            <button class="mini purple" id="btnGiveGems">+üíé</button>
          </div>

          <div class="row">
            <button class="mini red" id="btnAdminMax">MAX –∞–ø–≥—Ä–µ–π–¥—ã</button>
            <button class="mini gray" id="btnAdminStage">Stage +1</button>
            <button class="mini gray" id="btnAdminPet">–ü–∏—Ç–æ–º–µ—Ü</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHEST -->
  <div class="modal" id="mChest">
    <div class="sheet">
      <div class="sheetTop">
        <div>
          <h2>–°—É–Ω–¥—É–∫ —ç—Ç–∞–ø–∞</h2>
          <div class="muted">–û—Ç–∫—Ä–æ–π —Å—É–Ω–¥—É–∫, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.</div>
        </div>
        <div class="tag">Stage <span id="uiChestStage">1</span></div>
      </div>
      <div class="sheetBody">
        <div class="chestWrap">
          <div style="font-weight:1000;font-size:14px">–≠—Ç–∞–ø –ø—Ä–æ–π–¥–µ–Ω! üéâ</div>
          <div class="muted">–¢–∞–ø–Ω–∏ –ø–æ —Å—É–Ω–¥—É–∫—É</div>
          <div class="chestArea">
            <div class="chest" id="chestBtn">
              <div class="shine"></div>
              <div class="lock">üîí</div>
            </div>
          </div>

          <div class="cardItem" id="rewardBox" style="display:none;flex:0 0 auto;max-width:520px">
            <div class="headRow">
              <div class="name" id="rewardTitle">–ù–∞–≥—Ä–∞–¥–∞</div>
              <div class="tag" id="rewardTag">‚Äî</div>
            </div>
            <div class="muted" id="rewardDesc">‚Äî</div>
          </div>

          <div class="row" style="justify-content:center">
            <button class="mini gray" id="btnChestContinue" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚ñ∂</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  const canvas = $('c');
  const ctx = canvas.getContext('2d', {alpha:true});

  const uiStage = $('uiStage');
  const uiWave = $('uiWave');
  const uiWaveInStage = $('uiWaveInStage');
  const uiCoins = $('uiCoins');
  const uiGems  = $('uiGems');
  const uiBest  = $('uiBest');

  const uiCoins2= $('uiCoins2');
  const uiGems2 = $('uiGems2');
  const uiGems3 = $('uiGems3');

  const toastEl = $('toast');
  const bannerEl= $('banner');

  const start = $('start');
  const btnContinue = $('btnContinue');
  const btnStart = $('btnStart');
  const btnReset = $('btnReset');
  const startTitle = $('startTitle');
  const startDesc = $('startDesc');

  const btnPause = $('btnPause');
  const btnShop  = $('btnShop');
  const btnPets  = $('btnPets');
  const btnAdmin = $('btnAdmin');

  const mShop = $('mShop');
  const closeShop = $('closeShop');

  const tabUp = $('tabUp');
  const tabWp = $('tabWp');
  const tabCs = $('tabCs');
  const shopUpgrades = $('shopUpgrades');
  const shopWeapons  = $('shopWeapons');
  const shopCosmetics= $('shopCosmetics');
  const shopSubtitle = $('shopSubtitle');

  const mPets = $('mPets');
  const closePets = $('closePets');
  const spin1 = $('spin1');
  const spin10= $('spin10');
  const invGrid = $('invGrid');
  const activePetName = $('activePetName');
  const activePetRar  = $('activePetRar');
  const petDmgEl = $('petDmg');
  const petCoinEl= $('petCoin');

  const mAdmin = $('mAdmin');
  const closeAdmin = $('closeAdmin');
  const adminPass = $('adminPass');
  const giveCoins = $('giveCoins');
  const giveGems  = $('giveGems');
  const btnGiveCoins = $('btnGiveCoins');
  const btnGiveGems  = $('btnGiveGems');
  const btnAdminMax  = $('btnAdminMax');
  const btnAdminStage= $('btnAdminStage');
  const btnAdminPet  = $('btnAdminPet');

  const mChest = $('mChest');
  const uiChestStage = $('uiChestStage');
  const chestBtn = $('chestBtn');
  const rewardBox = $('rewardBox');
  const rewardTitle = $('rewardTitle');
  const rewardDesc  = $('rewardDesc');
  const rewardTag   = $('rewardTag');
  const btnChestContinue = $('btnChestContinue');

  const chipShield = $('chipShield');
  const chipFrenzy = $('chipFrenzy');
  const chipFrenzyT= $('chipFrenzyT');

  // ===== Utils =====
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>a+Math.random()*(b-a);
  const irand=(a,b)=>Math.floor(rand(a,b+1));
  const now=()=>performance.now();

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('on');
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove('on'), 1500);
  }
  function banner(msg){
    bannerEl.textContent = msg;
    bannerEl.classList.remove('on');
    void bannerEl.offsetWidth;
    bannerEl.classList.add('on');
  }

  // ===== Resize =====
  const W = {w:360,h:640};
  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(r.width  * DPR);
    canvas.height = Math.floor(r.height * DPR);
    W.w = r.width; W.h = r.height;
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  // ===== Save / Economy =====
  const KEY='bb_long_progress_v2';
  const defSave=()=>({
    coins: 0,
    gems:  0,
    bestWave: 0,
    // progress
    currentWave: 1,      // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–µ–Ω–Ω–æ wave
    // upgrades
    up: { dmg:0, fire:0, speed:0, cannons:0, crit:0, magnet:0, lucky:0 },
    // weapons/cosmetics
    weaponSkin: 'classic',
    bulletFx: 'clean',
    cannonColor: 'blue',
    hat: 'none',
    // pets
    pets: { active:'none', owned:{ none:{lvl:1,copies:1} } }
  });

  function load(){
    try{
      const raw=localStorage.getItem(KEY);
      if(!raw) return defSave();
      const s=JSON.parse(raw);
      const b=defSave();
      const out = {...b, ...s};
      out.coins = Number(out.coins||0);
      out.gems  = Number(out.gems||0);
      out.bestWave = Number(out.bestWave||0);
      out.currentWave = Math.max(1, Number(out.currentWave||1));
      out.up = {...b.up, ...(out.up||{})};
      out.pets = {...b.pets, ...(out.pets||{})};
      out.pets.owned = (out.pets.owned && typeof out.pets.owned==='object') ? out.pets.owned : b.pets.owned;
      if(!out.pets.owned.none) out.pets.owned.none={lvl:1,copies:1};
      if(!out.pets.active) out.pets.active='none';
      out.weaponSkin = out.weaponSkin || 'classic';
      out.bulletFx = out.bulletFx || 'clean';
      out.cannonColor = out.cannonColor || 'blue';
      out.hat = out.hat || 'none';
      return out;
    }catch{ return defSave(); }
  }
  let SAVE=load();
  const save=()=>localStorage.setItem(KEY, JSON.stringify(SAVE));

  function hardReset(){
    SAVE = defSave();
    save();
    toast('–°–±—Ä–æ—à–µ–Ω–æ ‚úÖ');
    setOverlayText('–ó–∞–∂–∞–ª ‚Üí –≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º','–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω. –ú–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.');
    running=false; paused=false;
    start.style.display='flex';
    syncUI();
  }

  // ===== Stages =====
  const LEVELS_PER_STAGE = 5;
  function stageOf(w){ return Math.floor((w-1)/LEVELS_PER_STAGE)+1; }
  function stageStartWave(st){ return (st-1)*LEVELS_PER_STAGE + 1; }
  function waveInStage(w){ return ((w-1)%LEVELS_PER_STAGE) + 1; }
  function isBossStage(stage){ return stage % 5 === 0; } // Stage 5,10,15...

  // ===== Pets =====
  const RAR_ORDER = {common:1,uncommon:2,rare:3,legendary:4,mythic:5};
  const RAR = [
    {id:'common',    name:'–û–±—ã—á–Ω—ã–π',     p:0.60},
    {id:'uncommon',  name:'–ù–µ–æ–±—ã—á–Ω—ã–π',   p:0.22},
    {id:'rare',      name:'–†–µ–¥–∫–∏–π',      p:0.12},
    {id:'legendary', name:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', p:0.05},
    {id:'mythic',    name:'–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π',  p:0.01},
  ];
  const PETS = [
    {id:'slime', name:'–°–ª–∞–π–º', rar:'common', dmg:2, coin:4},
    {id:'cat', name:'–ö–æ—Ç', rar:'common', dmg:3, coin:3},
    {id:'dog', name:'–ü—ë—Å', rar:'common', dmg:3, coin:4},
    {id:'bee', name:'–ü—á–µ–ª–∞', rar:'common', dmg:4, coin:2},
    {id:'frog', name:'–õ—è–≥—É—à–∫–∞', rar:'common', dmg:2, coin:5},

    {id:'fox', name:'–õ–∏—Å', rar:'uncommon', dmg:6, coin:7},
    {id:'owl', name:'–°–æ–≤–∞', rar:'uncommon', dmg:5, coin:9},
    {id:'bat', name:'–õ–µ—Ç—É—á–∞—è –º—ã—à—å', rar:'uncommon', dmg:7, coin:6},
    {id:'drone', name:'–î—Ä–æ–Ω', rar:'uncommon', dmg:8, coin:5},

    {id:'panther', name:'–ü–∞–Ω—Ç–µ—Ä–∞', rar:'rare', dmg:12, coin:10},
    {id:'mecha', name:'–ú–µ—Ö–∞', rar:'rare', dmg:14, coin:8},
    {id:'djinn', name:'–î–∂–∏–Ω–Ω', rar:'rare', dmg:10, coin:14},

    {id:'phoenix', name:'–§–µ–Ω–∏–∫—Å', rar:'legendary', dmg:22, coin:16},
    {id:'dragon', name:'–î—Ä–∞–∫–æ–Ω', rar:'legendary', dmg:26, coin:14},
    {id:'orb', name:'–ó–æ–ª–æ—Ç–æ–π –û—Ä–±', rar:'legendary', dmg:18, coin:22},

    {id:'voidlord', name:'–í–æ–π–¥–õ–æ—Ä–¥', rar:'mythic', dmg:40, coin:28},
    {id:'celestial', name:'–ù–µ–±–æ–∂–∏—Ç–µ–ª—å', rar:'mythic', dmg:34, coin:36},
  ];
  const rarName=(id)=>RAR.find(r=>r.id===id)?.name || id;
  const petById=(id)=>PETS.find(p=>p.id===id) || null;

  function rollRarity(){
    const r=Math.random(); let acc=0;
    for(const t of RAR){ acc+=t.p; if(r<=acc) return t.id; }
    return 'common';
  }
  function rollPet(){
    const rar=rollRarity();
    const pool=PETS.filter(p=>p.rar===rar);
    return pool[irand(0,pool.length-1)];
  }
  function addPet(p){
    if(!SAVE.pets.owned[p.id]){
      SAVE.pets.owned[p.id]={lvl:1,copies:1};
    } else {
      const d=SAVE.pets.owned[p.id];
      d.copies++;
      const need = 3 + Math.floor((d.lvl-1)*1.6);
      if(d.copies >= need){
        d.copies -= need;
        d.lvl++;
        toast(`–ü–∏—Ç–æ–º–µ—Ü ${p.name} ‚Üí LVL ${d.lvl}!`);
      }
    }
    if(SAVE.pets.active==='none') SAVE.pets.active=p.id;
    save();
  }
  function petBuff(){
    const id=SAVE.pets.active || 'none';
    if(id==='none') return {name:'–ù–µ—Ç', rar:'common', lvl:1, dmgPct:0, coinPct:0};
    const p=petById(id);
    if(!p) return {name:'–ù–µ—Ç', rar:'common', lvl:1, dmgPct:0, coinPct:0};
    const lvl=SAVE.pets.owned[id]?.lvl || 1;
    const mult = 1 + (lvl-1)*0.18;
    return {
      name:p.name, rar:p.rar, lvl,
      dmgPct: Math.round(p.dmg*mult),
      coinPct: Math.round(p.coin*mult)
    };
  }

  // ===== Content / Shop =====
  const up=(id)=>SAVE.up[id]||0;

  // –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–æ–≥—Ä–µ—Å—Å: —Ü–µ–Ω—ã —É–º–µ—Ä–µ–Ω–Ω—ã–µ + —Ä–æ—Å—Ç –Ω–µ –±–µ—à–µ–Ω—ã–π
  const UPGRADES = [
    {id:'dmg',    name:'–£—Ä–æ–Ω',           desc:'+—É—Ä–æ–Ω –ø–æ —à–∞—Ä–∞–º',        base:55,  scale:1.42, max:70, cost:'coins'},
    {id:'fire',   name:'–°–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å',desc:'—Å—Ç—Ä–µ–ª—è–µ—à—å —á–∞—â–µ',       base:70,  scale:1.45, max:60, cost:'coins'},
    {id:'speed',  name:'–°–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å',  desc:'–ø—É–ª–∏ –ª–µ—Ç—è—Ç –±—ã—Å—Ç—Ä–µ–µ',    base:60,  scale:1.40, max:55, cost:'coins'},
    {id:'cannons',name:'+–ü—É—à–∫–∞',         desc:'–¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç–≤–æ–ª',       base:220, scale:1.75, max:6,  cost:'coins'},
    {id:'crit',   name:'–ö—Ä–∏—Ç',           desc:'—à–∞–Ω—Å –∫—Ä–∏—Ç-—É—Ä–æ–Ω–∞',       base:95,  scale:1.50, max:45, cost:'coins'},
    {id:'magnet', name:'–ú–∞–≥–Ω–∏—Ç',         desc:'—Ç—è–Ω–µ—Ç –ª—É—Ç —Å–∏–ª—å–Ω–µ–µ',     base:85,  scale:1.48, max:45, cost:'coins'},
    {id:'lucky',  name:'–õ–∞–∫–∏',           desc:'—á–∞—â–µ –≥–µ–º—ã/–±–∞—Ñ—ã/—Å—É–Ω–¥—É–∫', base:120, scale:1.55, max:35, cost:'coins'},
  ];

  function upgradeCost(it){
    return Math.floor(it.base * Math.pow(it.scale, up(it.id)));
  }
  function isUpgradeMaxed(it){ return up(it.id) >= it.max; }

  // Weapons (–∫–æ—Ä–ø—É—Å–∞) ‚Äî –∑–∞ –≥–µ–º—ã (–∫–æ—Å–º–µ—Ç–∏–∫–∞/–≤–∏–∑—É–∞–ª)
  const WEAPONS = [
    {id:'classic', name:'Classic', desc:'–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å', price:0,    rar:'common'},
    {id:'steel',   name:'Steel',   desc:'–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–ø—É—Å', price:140, rar:'uncommon'},
    {id:'carbon',  name:'Carbon',  desc:'–∫–∞—Ä–±–æ–Ω + –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –ª–∏–Ω–∏–∏', price:260, rar:'rare'},
    {id:'royal',   name:'Royal',   desc:'–∫–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –æ—Ç–¥–µ–ª–∫–∞', price:420, rar:'legendary'},
    {id:'myth',    name:'Myth',    desc:'–º–∏—Ñ–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–ø—É—Å', price:650, rar:'mythic'},
  ];
  // Cosmetics
  const COLORS = [
    {id:'blue', name:'–°–∏–Ω–∏–π', price:0},
    {id:'red', name:'–ö—Ä–∞—Å–Ω—ã–π', price:90},
    {id:'purple', name:'–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', price:120},
    {id:'black', name:'–ß—ë—Ä–Ω—ã–π', price:180},
    {id:'gold', name:'–ó–æ–ª–æ—Ç–æ–π', price:260},
    {id:'mint', name:'–ú—è—Ç–Ω—ã–π', price:90},
  ];
  const HATS = [
    {id:'none', name:'–ë–µ–∑ —à–∞–ø–∫–∏', price:0},
    {id:'cap', name:'–ö–µ–ø–∫–∞', price:120},
    {id:'crown', name:'–ö–æ—Ä–æ–Ω–∞', price:260},
    {id:'horns', name:'–†–æ–≥–∞', price:220},
    {id:'halo', name:'–ù–∏–º–±', price:260},
  ];
  const BULLET_FX = [
    {id:'clean', name:'–ß–∏—Å—Ç—ã–µ –ø—É–ª–∏', price:0},
    {id:'spark', name:'–ò—Å–∫—Ä—ã', price:120},
    {id:'trail', name:'–®–ª–µ–π—Ñ', price:180},
  ];

  // Owned sets
  function ensureOwned(){
    SAVE.owned = SAVE.owned || {weapons:{classic:true}, colors:{blue:true}, hats:{none:true}, fx:{clean:true}};
    SAVE.owned.weapons = SAVE.owned.weapons || {classic:true};
    SAVE.owned.colors  = SAVE.owned.colors  || {blue:true};
    SAVE.owned.hats    = SAVE.owned.hats    || {none:true};
    SAVE.owned.fx      = SAVE.owned.fx      || {clean:true};
  }
  ensureOwned();

  // ===== Game State =====
  let running=false, paused=false;
  let wave=1;

  let awaitingChest=false;
  let nextWaveAfterChest=1;
  let chestOpened=false;

  // buffs
  const buffs = { shield:false, frenzyT:0 };

  // player
  const player={x:0,y:0,targetX:null};

  // stats (derived)
  const ST={dmg:1, fireMs:150, spd:900, cannons:1, crit:0.05, magnet:0, coinMult:1, lucky:0};

  // entities
  const bullets=[];  // {x,y,vx,vy,r,dmg,crit}
  const balls=[];    // {x,y,vx,vy,r,hp,maxHp,boss,color,group}
  const loot=[];     // {x,y,vx,vy,type,r,grounded}
  const powerups=[]; // {x,y,vx,vy,type,r,grounded} shield/frenzy
  const particles=[];

  // boss ult
  const boss = {
    active:false,
    id:null,
    ultTimer:0,
    spawnTimer:0
  };
  const hazards=[]; // boss bombs: {x,y,vy,t,explodeT,r,alive}

  // ===== Visual palette for ball groups =====
  const GROUPS = [
    {id:0, fill:'rgba(255,255,255,.95)', stroke:'rgba(0,0,0,.12)'},
    {id:1, fill:'rgba(255,196,58,.95)', stroke:'rgba(154,106,0,.35)'},
    {id:2, fill:'rgba(46,196,255,.95)', stroke:'rgba(8,120,170,.35)'},
    {id:3, fill:'rgba(142,91,255,.95)', stroke:'rgba(92,31,180,.35)'},
    {id:4, fill:'rgba(55,209,122,.95)', stroke:'rgba(15,120,60,.35)'},
    {id:5, fill:'rgba(255,74,107,.95)', stroke:'rgba(140,20,45,.35)'},
  ];

  // ===== Apply stats =====
  function applyStats(){
    const pb=petBuff();
    const dmg = 1 + up('dmg')*0.85;
    const fire = 170 / (1 + up('fire')*0.06);
    const spd  = 980 + up('speed')*36;
    const cann = 1 + up('cannons');
    const crit = 0.05 + up('crit')*0.007;
    const mag  = up('magnet')*17;
    const lucky= up('lucky')*0.02;

    ST.dmg = dmg * (1 + pb.dmgPct/100);
    const frenzyMul = (buffs.frenzyT > 0) ? 0.55 : 1.0;
    ST.fireMs = clamp(fire * frenzyMul, 45, 220);
    ST.spd = clamp(spd, 900, 1900);
    ST.cannons = clamp(cann, 1, 7);
    ST.crit = clamp(crit, 0.05, 0.35);
    ST.magnet = mag;
    ST.coinMult = 1 + pb.coinPct/100;
    ST.lucky = clamp(lucky, 0, 0.60);
  }

  // ===== UI sync =====
  function syncUI(){
    const st = stageOf(wave);
    uiStage.textContent = st;
    uiWave.textContent = waveInStage(wave);
    uiWaveInStage.textContent = LEVELS_PER_STAGE;

    uiCoins.textContent = SAVE.coins;
    uiGems.textContent  = SAVE.gems;
    uiBest.textContent  = SAVE.bestWave;

    uiCoins2.textContent = SAVE.coins;
    uiGems2.textContent  = SAVE.gems;
    uiGems3.textContent  = SAVE.gems;

    const pb=petBuff();
    activePetName.textContent = `${pb.name} (LVL ${pb.lvl})`;
    activePetRar.textContent  = rarName(pb.rar);
    activePetRar.className = `rar ${pb.rar}`;
    petDmgEl.textContent = pb.dmgPct + '%';
    petCoinEl.textContent= pb.coinPct + '%';

    chipShield.classList.toggle('on', buffs.shield);
    chipFrenzy.classList.toggle('on', buffs.frenzyT > 0);
    chipFrenzyT.textContent = Math.ceil(buffs.frenzyT);

    // continue availability
    btnContinue.disabled = !(SAVE.currentWave && SAVE.currentWave>1);
    btnContinue.style.opacity = btnContinue.disabled ? 0.5 : 1;
  }

  function setOverlayText(title, desc){
    startTitle.textContent = title;
    startDesc.textContent = desc;
  }

  // ===== Background drawing =====
  function drawBG(time){
    const g = ctx.createLinearGradient(0,0,0,W.h);
    g.addColorStop(0, '#86CDF7');
    g.addColorStop(0.65, '#CFEFFF');
    g.addColorStop(1, '#EAF8FF');
    ctx.fillStyle=g;
    ctx.fillRect(0,0,W.w,W.h);

    ctx.save();
    ctx.globalAlpha=0.92;
    for(let i=0;i<4;i++){
      const x = (i*220 + (time*0.02)) % (W.w+260) - 130;
      const y = 80 + i*40;
      cloud(x,y, 1.0 - i*0.08);
    }
    ctx.restore();

    mountain(0.78, '#87B7D9');
    mountain(0.88, '#6DA3C9');

    ctx.fillStyle='#34C759';
    ctx.fillRect(0, W.h-90, W.w, 90);
    ctx.fillStyle='#2FB355';
    ctx.fillRect(0, W.h-70, W.w, 70);
  }
  function cloud(x,y,s){
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.beginPath();
    ctx.ellipse(x, y, 40*s, 22*s, 0, 0, Math.PI*2);
    ctx.ellipse(x+35*s, y+4*s, 46*s, 26*s, 0, 0, Math.PI*2);
    ctx.ellipse(x+80*s, y, 40*s, 22*s, 0, 0, Math.PI*2);
    ctx.closePath(); ctx.fill();
  }
  function mountain(hMul, color){
    const baseY = W.h-90;
    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.moveTo(0, baseY);
    const peaks = 5;
    for(let i=0;i<=peaks;i++){
      const px = (i/peaks)*W.w;
      const py = baseY - (120*hMul) - (i%2?40:0);
      ctx.lineTo(px, py);
    }
    ctx.lineTo(W.w, baseY);
    ctx.closePath();
    ctx.globalAlpha=0.65;
    ctx.fill();
    ctx.globalAlpha=1;
  }

  // ===== FX =====
  function burst(x,y,count=18,power=6,hue=50){
    for(let i=0;i<count;i++){
      const a=rand(0,Math.PI*2);
      const s=rand(1.2,power);
      particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:rand(18,42),kind:'spark',hue:hue+rand(-30,30),size:rand(2,3.6)});
    }
  }
  function confetti(){
    for(let i=0;i<90;i++){
      particles.push({x:rand(0,W.w),y:rand(-30,10),vx:rand(-1.6,1.6),vy:rand(1.2,3.4),life:rand(70,120),kind:'conf',hue:rand(0,360),size:rand(2.2,4.2),rot:rand(0,Math.PI*2),vr:rand(-0.2,0.2)});
    }
  }
  function stepParticles(dt60){
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.life-=dt60;
      if(p.life<=0){particles.splice(i,1);continue;}
      if(p.kind==='spark'){
        p.vy += 0.11*dt60;
        p.x += p.vx*dt60;
        p.y += p.vy*dt60;
        p.vx*=0.98; p.vy*=0.98;
      } else {
        p.vy += 0.03*dt60;
        p.x += p.vx*dt60;
        p.y += p.vy*dt60;
        p.rot += (p.vr||0)*dt60;
      }
    }
  }
  function drawParticles(){
    for(const p of particles){
      if(p.kind==='spark'){
        ctx.save();
        const a=clamp(p.life/50,0,1);
        ctx.globalAlpha=0.9*a;
        ctx.fillStyle=`hsla(${p.hue},95%,55%,1)`;
        ctx.shadowColor=`hsla(${p.hue},95%,55%,.45)`;
        ctx.shadowBlur=12;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
        ctx.restore();
      } else {
        ctx.save();
        const a=clamp(p.life/130,0,1);
        ctx.globalAlpha=0.95*a;
        ctx.translate(p.x,p.y);
        ctx.rotate(p.rot||0);
        ctx.fillStyle=`hsla(${p.hue},95%,55%,1)`;
        ctx.fillRect(-p.size, -p.size*0.6, p.size*2, p.size*1.2);
        ctx.restore();
      }
    }
  }

  // ===== Ball spawn (grouped colors) =====
  function spawnBallCluster({count, baseHp, bossBall=false, groupId=null}){
    const gid = (groupId===null) ? irand(1,5) : groupId; // 1..5 colorful
    for(let i=0;i<count;i++){
      const r = rand(22, 42) * (Math.random()<0.18?1.25:1.0);
      const hp = Math.floor(baseHp * rand(0.75, 1.35));
      const isBoss = bossBall && (i===0);

      const maxHp = isBoss ? Math.floor(hp*6.5) : hp;

      const b = {
        x: rand(r+16, W.w-r-16),
        y: rand(140, 240),
        vx: rand(-1.7, 1.7),
        vy: rand(-0.6, 0.6),
        r,
        hp: maxHp,
        maxHp: maxHp,
        boss: isBoss,
        group: gid,
      };
      balls.push(b);
      if(isBoss){
        boss.active=true;
        boss.id = b;
        boss.ultTimer = 5 + rand(0,2);
        boss.spawnTimer = 2 + rand(0,2);
      }
    }
  }

  function spawnWave(w){
    applyStats();

    // Save current wave (–ø–µ—Ä—Å–∏—Å—Ç)
    SAVE.currentWave = w;
    save();

    // base reward per wave (–±—ã—Å—Ç—Ä–µ–µ —ç–∫–æ–Ω–æ–º–∏–∫–∞)
    const st = stageOf(w);
    const wIn = waveInStage(w);
    const stageBonus = isBossStage(st) ? 1.25 : 1.0;

    SAVE.coins += Math.floor((12 + w*0.85) * stageBonus);
    if(w % 3 === 0) SAVE.gems += Math.floor(2 + ST.lucky*3);
    save();

    // reset boss flags
    boss.active=false;
    boss.id=null;

    const stage = stageOf(w);
    const inStage = waveInStage(w);
    const bossStage = isBossStage(stage);
    const isBossWave = bossStage && (inStage === LEVELS_PER_STAGE);

    if(isBossWave){
      // Boss wave: 1 huge boss + small helpers
      const baseHp = 70 + w*13;
      spawnBallCluster({count:1, baseHp, bossBall:true, groupId: 3}); // purple boss
      spawnBallCluster({count: irand(2,4), baseHp: Math.floor(baseHp*0.55), bossBall:false, groupId: irand(1,5)});
      banner(`–ë–û–°–°! Stage ${stage} ‚Ä¢ LvL 5/5`);
      toast('–û—Å—Ç–æ—Ä–æ–∂–Ω–æ: —É–ª—å—Ç–∞ –±–æ—Å—Å–∞!');
      syncUI();
      return;
    }

    // Normal waves / boss-stage prewaves
    const count = clamp(3 + Math.floor(w/3), 3, 8);
    const baseHp = 16 + w*6;

    // 2-3 clusters with different colors
    const clusters = clamp(2 + (Math.random()<0.35?1:0), 2, 3);
    let left = count;
    for(let c=0;c<clusters;c++){
      const n = (c===clusters-1) ? left : Math.max(1, Math.floor(left/(clusters-c) * rand(0.75,1.05)));
      left -= n;
      spawnBallCluster({count:n, baseHp: Math.floor(baseHp*rand(0.85,1.15)), bossBall:false, groupId: irand(1,5)});
    }

    syncUI();
  }

  // ===== Loot / Drops =====
  function maybeDropPowerup(ball){
    const base = ball.boss ? 0.28 : 0.05;
    const chance = clamp(base + ST.lucky*0.35, 0, 0.55);
    if(Math.random() > chance) return;
    const type = (Math.random() < 0.55) ? 'shield' : 'frenzy';
    powerups.push({
      x: ball.x, y: ball.y,
      vx: rand(-110,110),
      vy: rand(-520,-260),
      type,
      r: 10,
      grounded:false
    });
  }

  function splitAndLoot(ball){
    // coins drop + gems + keep on ground
    const stage = stageOf(wave);
    const stageMul = 1 + stage*0.06;
    const coinsDrop = clamp(Math.floor((ball.maxHp/7) * stageMul), 6, 55);

    for(let i=0;i<coinsDrop;i++){
      loot.push({
        x:ball.x, y:ball.y,
        vx:rand(-140,140),
        vy:rand(-560,-240),
        type:'coin',
        r:7.5,
        grounded:false
      });
    }

    const gemBase = ball.boss ? 0.90 : 0.14;
    const gemChance = clamp(gemBase + ST.lucky*0.35, 0, 0.95);
    if(Math.random() < gemChance){
      const gemCount = ball.boss ? (2 + Math.floor(stage/3)) : 1;
      for(let k=0;k<gemCount;k++){
        loot.push({
          x:ball.x, y:ball.y,
          vx:rand(-130,130),
          vy:rand(-560,-280),
          type:'gem',
          r:8.5,
          grounded:false
        });
      }
    }

    maybeDropPowerup(ball);

    // split only non-boss
    if(!ball.boss && ball.r > 24){
      const nr = ball.r*0.72;
      const nh = Math.max(8, Math.floor(ball.maxHp*0.45));
      for(const s of [-1,1]){
        balls.push({
          x: ball.x + s*nr*0.3,
          y: ball.y,
          vx: ball.vx + s*rand(1.0,2.0),
          vy: rand(-1.2,-0.2),
          r: nr,
          hp: Math.floor(nh*0.85),
          maxHp: nh,
          boss:false,
          group: ball.group
        });
      }
    }
  }

  // ===== Shooting =====
  let lastShot = 0;
  function shoot(){
    const t = now();
    if(t - lastShot < ST.fireMs) return;
    lastShot = t;

    const n = ST.cannons;
    const spread = 0.18;

    for(let i=0;i<n;i++){
      const k = (n===1)?0:(i-(n-1)/2);
      const vx = k * (ST.spd*spread*0.001);
      const vy = -ST.spd;
      const crit = Math.random() < ST.crit;
      const dmg  = ST.dmg * (crit ? 1.8 : 1);
      bullets.push({x:player.x,y:player.y-62,vx,vy,r:3.6,dmg,crit});
    }
  }

  // ===== Input: drag =====
  function clientXToWorldX(cx){
    const r = canvas.getBoundingClientRect();
    return (cx - r.left) * (W.w / r.width);
  }
  let dragging=false, pid=null;
  canvas.addEventListener('pointerdown', (e)=>{
    if(!running || paused || awaitingChest) return;
    if(anyModalOpen()) return;
    dragging=true; pid=e.pointerId;
    try{ canvas.setPointerCapture(pid); }catch{}
    player.targetX = clientXToWorldX(e.clientX);
  }, {passive:false});
  canvas.addEventListener('pointermove', (e)=>{
    if(!dragging || e.pointerId!==pid) return;
    player.targetX = clientXToWorldX(e.clientX);
  }, {passive:false});
  function endDrag(e){
    if(e.pointerId!==pid) return;
    dragging=false; pid=null;
    player.targetX=null;
  }
  canvas.addEventListener('pointerup', endDrag, {passive:false});
  canvas.addEventListener('pointercancel', endDrag, {passive:false});

  // ===== Keyboard fallback =====
  const keys=new Set();
  addEventListener('keydown', e=>keys.add(e.key));
  addEventListener('keyup', e=>keys.delete(e.key));
  const left=()=>keys.has('ArrowLeft')||keys.has('a')||keys.has('A');
  const right=()=>keys.has('ArrowRight')||keys.has('d')||keys.has('D');

  // ===== Modal open helper =====
  function anyModalOpen(){
    return mShop.classList.contains('on') ||
           mPets.classList.contains('on') ||
           mAdmin.classList.contains('on') ||
           mChest.classList.contains('on');
  }

  // ===== Shop render =====
  function miniPreviewGunHTML(label){
    return `
      <div class="previewGun">
        <div class="badge">${label}</div>
        <div style="font-weight:1000;opacity:.85">preview</div>
      </div>
    `;
  }

  function renderShopTab(which){
    // toggle
    shopUpgrades.style.display = (which==='up') ? 'flex':'none';
    shopWeapons.style.display  = (which==='wp') ? 'flex':'none';
    shopCosmetics.style.display= (which==='cs') ? 'flex':'none';

    tabUp.classList.toggle('on', which==='up');
    tabWp.classList.toggle('on', which==='wp');
    tabCs.classList.toggle('on', which==='cs');

    shopSubtitle.textContent =
      which==='up' ? '–ü—Ä–æ–∫–∞—á–∫–∞ ‚Äî –ª–∏—Å—Ç–∞–π –≤–ø—Ä–∞–≤–æ' :
      which==='wp' ? '–û—Ä—É–∂–∏–µ ‚Äî –º–µ–Ω—è–µ—Ç –º–æ–¥–µ–ª—å–∫—É –∫–æ—Ä–ø—É—Å–∞' :
      '–ö–æ—Å–º–µ—Ç–∏–∫–∞ ‚Äî —Ü–≤–µ—Ç / —à–∞–ø–∫–∏ / —ç—Ñ—Ñ–µ–∫—Ç—ã';

    if(which==='up') renderUpgrades();
    if(which==='wp') renderWeapons();
    if(which==='cs') renderCosmetics();
  }

  function renderUpgrades(){
    shopUpgrades.innerHTML='';
    syncUI();
    for(const it of UPGRADES){
      const lv = up(it.id);
      const mx = it.max;
      const isMax = lv>=mx;
      const price = upgradeCost(it);
      const can = SAVE.coins >= price;

      const el = document.createElement('div');
      el.className='cardItem';
      el.innerHTML = `
        <div class="headRow">
          <div>
            <div class="name">${it.name} <span style="opacity:.55">LVL ${lv}/${mx}</span></div>
            <div class="muted">${it.desc}</div>
          </div>
          <div class="price">ü™ô ${isMax?'MAX':price}</div>
        </div>
        ${miniPreviewGunHTML(it.id==='cannons' ? ('x'+(1+lv)+' ‚Üí x'+(1+lv+1)) : 'UP')}
        <div class="row">
          <div class="muted">${isMax?'–º–∞–∫—Å —É—Ä–æ–≤–µ–Ω—å':(can?'–º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å ‚úÖ':'–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ü•≤')}</div>
          <button class="mini" ${isMax||!can?'disabled':''}>–ö—É–ø–∏—Ç—å</button>
        </div>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        if(isMax) return;
        const p=upgradeCost(it);
        if(SAVE.coins < p) return;
        SAVE.coins -= p;
        SAVE.up[it.id] = lv+1;
        save();
        applyStats();
        confetti();
        burst(W.w*0.5, W.h*0.35, 90, 7.0, 55);
        toast(`–ö—É–ø–ª–µ–Ω–æ: ${it.name}`);
        renderUpgrades();
      });
      shopUpgrades.appendChild(el);
    }
  }

  function renderWeapons(){
    shopWeapons.innerHTML='';
    ensureOwned();
    syncUI();

    for(const wpn of WEAPONS){
      const owned = !!SAVE.owned.weapons[wpn.id];
      const active = SAVE.weaponSkin === wpn.id;
      const canBuy = SAVE.gems >= wpn.price;

      const el=document.createElement('div');
      el.className='cardItem';
      el.innerHTML = `
        <div class="headRow">
          <div>
            <div class="name">${wpn.name} ${wpn.price?`<span class="rar ${wpn.rar}">${rarName(wpn.rar)}</span>`:''}</div>
            <div class="muted">${wpn.desc}</div>
          </div>
          <div class="price">${wpn.price?`üíé ${wpn.price}`:'FREE'}</div>
        </div>
        ${miniPreviewGunHTML(active?'ACTIVE':(owned?'OWNED':'LOCKED'))}
        <div class="row">
          <div class="muted">${active?'–≤—ã–±—Ä–∞–Ω–æ ‚úÖ':(owned?'–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å':'–∫—É–ø–∏—Ç—å –∑–∞ üíé')}</div>
          <button class="mini ${owned?'gray':'purple'}" ${(!owned && !canBuy && wpn.price>0)?'disabled':''}>
            ${owned ? '–í—ã–±—Ä–∞—Ç—å' : (wpn.price===0?'–ü–æ–ª—É—á–∏—Ç—å':'–ö—É–ø–∏—Ç—å')}
          </button>
        </div>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        ensureOwned();
        if(owned){
          SAVE.weaponSkin = wpn.id;
          save();
          toast(`–û—Ä—É–∂–∏–µ: ${wpn.name}`);
          renderWeapons();
          return;
        }
        if(wpn.price===0){
          SAVE.owned.weapons[wpn.id]=true;
          SAVE.weaponSkin = wpn.id;
          save();
          confetti();
          toast(`–û—Ç–∫—Ä—ã—Ç–æ: ${wpn.name}`);
          renderWeapons();
          return;
        }
        if(SAVE.gems < wpn.price) return;
        SAVE.gems -= wpn.price;
        SAVE.owned.weapons[wpn.id]=true;
        SAVE.weaponSkin = wpn.id;
        save();
        confetti();
        burst(W.w*0.5, W.h*0.35, 90, 7.0, 200);
        toast(`–ö—É–ø–ª–µ–Ω–æ: ${wpn.name}`);
        renderWeapons();
      });
      shopWeapons.appendChild(el);
    }
  }

  function renderCosmetics(){
    shopCosmetics.innerHTML='';
    ensureOwned();
    syncUI();

    const section = (title) => {
      const box=document.createElement('div');
      box.className='cardItem';
      box.style.flex='0 0 min(520px, 92vw)';
      box.innerHTML=`<div class="name">${title}</div><div class="muted">–ª–∏—Å—Ç–∞–π –≤–ø—Ä–∞–≤–æ —Ç–æ–≤–∞—Ä—ã –Ω–∏–∂–µ</div>`;
      return box;
    };

    // Colors rail (nested)
    const colorsCard = document.createElement('div');
    colorsCard.className='cardItem';
    colorsCard.innerHTML = `<div class="headRow"><div><div class="name">–¶–≤–µ—Ç –ø—É—à–∫–∏</div><div class="muted">–º–µ–Ω—è–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</div></div><div class="tag">Cosmetic</div></div>`;
    const railC = document.createElement('div');
    railC.className='rail';
    railC.style.padding='6px 0 0';
    railC.style.scrollSnapType='x mandatory';

    for(const c of COLORS){
      const owned = !!SAVE.owned.colors[c.id];
      const active = SAVE.cannonColor === c.id;
      const canBuy = SAVE.gems >= c.price;

      const item=document.createElement('div');
      item.className='cardItem';
      item.style.flex='0 0 min(260px, 70vw)';
      item.innerHTML=`
        <div class="headRow">
          <div class="name">${c.name}</div>
          <div class="price">${c.price?`üíé ${c.price}`:'FREE'}</div>
        </div>
        <div class="muted">${active?'–≤—ã–±—Ä–∞–Ω–æ ‚úÖ':(owned?'–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å':'–∫—É–ø–∏—Ç—å')}</div>
        <button class="mini ${owned?'gray':'purple'}" ${(!owned && !canBuy && c.price>0)?'disabled':''}>
          ${owned?'–í—ã–±—Ä–∞—Ç—å':(c.price===0?'–ü–æ–ª—É—á–∏—Ç—å':'–ö—É–ø–∏—Ç—å')}
        </button>
      `;
      item.querySelector('button').addEventListener('click', ()=>{
        ensureOwned();
        if(owned){
          SAVE.cannonColor=c.id; save(); toast(`–¶–≤–µ—Ç: ${c.name}`); renderCosmetics(); return;
        }
        if(c.price===0){
          SAVE.owned.colors[c.id]=true;
          SAVE.cannonColor=c.id;
          save(); confetti(); toast(`–û—Ç–∫—Ä—ã—Ç–æ: ${c.name}`); renderCosmetics(); return;
        }
        if(SAVE.gems < c.price) return;
        SAVE.gems -= c.price;
        SAVE.owned.colors[c.id]=true;
        SAVE.cannonColor=c.id;
        save(); confetti(); burst(W.w*0.5,W.h*0.35,80,7.0,220);
        toast(`–ö—É–ø–ª–µ–Ω–æ: ${c.name}`);
        renderCosmetics();
      });
      railC.appendChild(item);
    }
    colorsCard.appendChild(railC);

    // Hats
    const hatsCard = document.createElement('div');
    hatsCard.className='cardItem';
    hatsCard.innerHTML = `<div class="headRow"><div><div class="name">–£–∫—Ä–∞—à–µ–Ω–∏—è (—à–∞–ø–∫–∏)</div><div class="muted">–∫–æ—Å–º–µ—Ç–∏–∫–∞ —Å–≤–µ—Ä—Ö—É –ø—É—à–∫–∏</div></div><div class="tag">Hat</div></div>`;
    const railH = document.createElement('div');
    railH.className='rail';
    railH.style.padding='6px 0 0';

    for(const h of HATS){
      const owned = !!SAVE.owned.hats[h.id];
      const active = SAVE.hat === h.id;
      const canBuy = SAVE.gems >= h.price;

      const item=document.createElement('div');
      item.className='cardItem';
      item.style.flex='0 0 min(260px, 70vw)';
      item.innerHTML=`
        <div class="headRow">
          <div class="name">${h.name}</div>
          <div class="price">${h.price?`üíé ${h.price}`:'FREE'}</div>
        </div>
        <div class="muted">${active?'–Ω–∞–¥–µ—Ç–æ ‚úÖ':(owned?'–º–æ–∂–Ω–æ –Ω–∞–¥–µ—Ç—å':'–∫—É–ø–∏—Ç—å')}</div>
        <button class="mini ${owned?'gray':'purple'}" ${(!owned && !canBuy && h.price>0)?'disabled':''}>
          ${owned?'–ù–∞–¥–µ—Ç—å':(h.price===0?'–ü–æ–ª—É—á–∏—Ç—å':'–ö—É–ø–∏—Ç—å')}
        </button>
      `;
      item.querySelector('button').addEventListener('click', ()=>{
        ensureOwned();
        if(owned){
          SAVE.hat=h.id; save(); toast(`–®–∞–ø–∫–∞: ${h.name}`); renderCosmetics(); return;
        }
        if(h.price===0){
          SAVE.owned.hats[h.id]=true; SAVE.hat=h.id;
          save(); confetti(); toast(`–û—Ç–∫—Ä—ã—Ç–æ: ${h.name}`); renderCosmetics(); return;
        }
        if(SAVE.gems < h.price) return;
        SAVE.gems -= h.price;
        SAVE.owned.hats[h.id]=true;
        SAVE.hat=h.id;
        save(); confetti(); burst(W.w*0.5,W.h*0.35,80,7.0,180);
        toast(`–ö—É–ø–ª–µ–Ω–æ: ${h.name}`);
        renderCosmetics();
      });
      railH.appendChild(item);
    }
    hatsCard.appendChild(railH);

    // Bullet FX
    const fxCard = document.createElement('div');
    fxCard.className='cardItem';
    fxCard.innerHTML = `<div class="headRow"><div><div class="name">–≠—Ñ—Ñ–µ–∫—Ç—ã –ø—É–ª—å</div><div class="muted">–≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å–ª–µ–¥</div></div><div class="tag">FX</div></div>`;
    const railF = document.createElement('div');
    railF.className='rail';
    railF.style.padding='6px 0 0';

    for(const fx of BULLET_FX){
      const owned = !!SAVE.owned.fx[fx.id];
      const active = SAVE.bulletFx === fx.id;
      const canBuy = SAVE.gems >= fx.price;

      const item=document.createElement('div');
      item.className='cardItem';
      item.style.flex='0 0 min(260px, 70vw)';
      item.innerHTML=`
        <div class="headRow">
          <div class="name">${fx.name}</div>
          <div class="price">${fx.price?`üíé ${fx.price}`:'FREE'}</div>
        </div>
        <div class="muted">${active?'–≤–∫–ª—é—á–µ–Ω–æ ‚úÖ':(owned?'–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å':'–∫—É–ø–∏—Ç—å')}</div>
        <button class="mini ${owned?'gray':'purple'}" ${(!owned && !canBuy && fx.price>0)?'disabled':''}>
          ${owned?'–í—ã–±—Ä–∞—Ç—å':(fx.price===0?'–ü–æ–ª—É—á–∏—Ç—å':'–ö—É–ø–∏—Ç—å')}
        </button>
      `;
      item.querySelector('button').addEventListener('click', ()=>{
        ensureOwned();
        if(owned){
          SAVE.bulletFx=fx.id; save(); toast(`FX: ${fx.name}`); renderCosmetics(); return;
        }
        if(fx.price===0){
          SAVE.owned.fx[fx.id]=true; SAVE.bulletFx=fx.id;
          save(); confetti(); toast(`–û—Ç–∫—Ä—ã—Ç–æ: ${fx.name}`); renderCosmetics(); return;
        }
        if(SAVE.gems < fx.price) return;
        SAVE.gems -= fx.price;
        SAVE.owned.fx[fx.id]=true;
        SAVE.bulletFx=fx.id;
        save(); confetti(); burst(W.w*0.5,W.h*0.35,80,7.0,260);
        toast(`–ö—É–ø–ª–µ–Ω–æ: ${fx.name}`);
        renderCosmetics();
      });
      railF.appendChild(item);
    }
    fxCard.appendChild(railF);

    shopCosmetics.appendChild(colorsCard);
    shopCosmetics.appendChild(hatsCard);
    shopCosmetics.appendChild(fxCard);
  }

  // ===== Pets inventory render =====
  function renderInv(){
    invGrid.innerHTML='';
    const owned = SAVE.pets.owned;
    const items = Object.keys(owned)
      .filter(id=>id!=='none')
      .map(id=>{
        const p=petById(id);
        if(!p) return null;
        return {id,p, lvl:owned[id].lvl, copies:owned[id].copies};
      })
      .filter(Boolean)
      .sort((a,b)=>RAR_ORDER[b.p.rar]-RAR_ORDER[a.p.rar] || b.lvl-a.lvl);

    if(items.length===0){
      const el=document.createElement('div');
      el.className='cardItem';
      el.style.flex='0 0 min(420px, 85vw)';
      el.innerHTML=`<div class="name">–ü–∏—Ç–æ–º—Ü–µ–≤ –Ω–µ—Ç üò¢</div><div class="muted">–ö—Ä—É—Ç–∏ —Ä—É–ª–µ—Ç–∫—É –∑–∞ üíé</div>`;
      invGrid.appendChild(el);
      return;
    }

    for(const it of items){
      const active = SAVE.pets.active===it.id;
      const mult = 1 + (it.lvl-1)*0.18;
      const dmg = Math.round(it.p.dmg*mult);
      const coin= Math.round(it.p.coin*mult);

      const el=document.createElement('div');
      el.className='cardItem';
      el.style.flex='0 0 min(320px, 85vw)';
      el.innerHTML=`
        <div class="headRow">
          <div>
            <div class="name">${it.p.name} <span style="opacity:.6">LVL ${it.lvl}</span></div>
            <div class="muted">+${dmg}% DMG ‚Ä¢ +${coin}% COIN</div>
          </div>
          <span class="rar ${it.p.rar}">${rarName(it.p.rar)}</span>
        </div>
        <div class="row">
          <div class="muted">${active?'–ê–∫—Ç–∏–≤–µ–Ω ‚úÖ':'–ú–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}</div>
          <button class="mini gray" ${active?'disabled':''}>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      `;
      el.querySelector('button').addEventListener('click', ()=>{
        SAVE.pets.active=it.id;
        save();
        applyStats();
        confetti();
        toast(`–ê–∫—Ç–∏–≤–µ–Ω: ${it.p.name}`);
        renderInv();
        syncUI();
      });
      invGrid.appendChild(el);
    }
  }

  // ===== Pets roulette =====
  let spinning=false;
  function spin(costGems, times){
    if(spinning) return;
    if(SAVE.gems < costGems){ toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –≥–µ–º–æ–≤ üíé'); return; }
    SAVE.gems -= costGems;
    save();

    spinning=true;
    const results=[];
    for(let i=0;i<times;i++) results.push(rollPet());
    for(const p of results) addPet(p);

    confetti();
    burst(W.w*0.5, W.h*0.3, 110, 7.8, 200);

    const best = results.slice().sort((a,b)=>RAR_ORDER[b.rar]-RAR_ORDER[a.rar])[0];
    toast(times===1 ? `–í—ã–ø–∞–ª: ${best.name} (${rarName(best.rar)})` : `x10 –≥–æ—Ç–æ–≤–æ! –õ—É—á—à–∏–π: ${best.name}`);
    spinning=false;

    renderInv();
    syncUI();
  }

  // ===== Admin =====
  const ADMIN_PASSWORD = '112';
  function adminOk(){ return (adminPass.value||'').trim() === ADMIN_PASSWORD; }

  // ===== Chest =====
  function openStageChest(stage){
    awaitingChest=true;
    paused=true;
    chestOpened=false;
    uiChestStage.textContent = stage;
    rewardBox.style.display='none';
    btnChestContinue.disabled=true;
    chestBtn.classList.remove('openAnim');
    mChest.classList.add('on');
  }

  function rollChestReward(stage){
    // –í–µ—Å—ã: coins 52%, gems 25%, pet 13%, upgrade 10%
    const r=Math.random();
    const luck = clamp(ST.lucky, 0, 0.60);
    const petBoost = luck*0.10;
    const upBoost  = luck*0.08;

    if(r < 0.52 - petBoost){
      const amount = Math.floor(260 + stage*190 + rand(0, stage*90));
      return {type:'coins', amount};
    } else if(r < 0.77 - upBoost){
      const amount = Math.floor(10 + stage*4 + rand(0, 4+stage));
      return {type:'gems', amount};
    } else if(r < 0.90){
      const pet = rollPet();
      return {type:'pet', pet};
    } else {
      const pool = UPGRADES.filter(it => up(it.id) < it.max);
      if(pool.length===0){
        const amount = Math.floor(420 + stage*220);
        return {type:'coins', amount};
      }
      const it = pool[irand(0, pool.length-1)];
      return {type:'upgrade', upId: it.id, upName: it.name};
    }
  }

  function applyChestReward(rew){
    if(rew.type==='coins'){
      SAVE.coins += rew.amount;
      rewardTitle.textContent = '–ù–∞–≥—Ä–∞–¥–∞: ü™ô –ú–æ–Ω–µ—Ç—ã';
      rewardDesc.textContent = `+${rew.amount} ü™ô`;
      rewardTag.textContent = 'Coins';
      burst(W.w*0.5, W.h*0.28, 120, 8.0, 55);
      confetti();
      toast(`–°—É–Ω–¥—É–∫: +${rew.amount} ü™ô`);
    } else if(rew.type==='gems'){
      SAVE.gems += rew.amount;
      rewardTitle.textContent = '–ù–∞–≥—Ä–∞–¥–∞: üíé –ì–µ–º—ã';
      rewardDesc.textContent = `+${rew.amount} üíé`;
      rewardTag.textContent = 'Gems';
      burst(W.w*0.5, W.h*0.28, 120, 8.0, 290);
      confetti();
      toast(`–°—É–Ω–¥—É–∫: +${rew.amount} üíé`);
    } else if(rew.type==='pet'){
      addPet(rew.pet);
      rewardTitle.textContent = '–ù–∞–≥—Ä–∞–¥–∞: üêæ –ü–∏—Ç–æ–º–µ—Ü';
      rewardDesc.textContent = `${rew.pet.name} (${rarName(rew.pet.rar)})`;
      rewardTag.textContent = 'Pet';
      burst(W.w*0.5, W.h*0.28, 150, 9.0, 200);
      confetti();
      toast(`–°—É–Ω–¥—É–∫: –ø–∏—Ç–æ–º–µ—Ü ${rew.pet.name}`);
    } else if(rew.type==='upgrade'){
      SAVE.up[rew.upId] = (SAVE.up[rew.upId]||0) + 1;
      rewardTitle.textContent = '–ù–∞–≥—Ä–∞–¥–∞: üîß –ü—Ä–æ–∫–∞—á–∫–∞';
      rewardDesc.textContent = `${rew.upName} +1 —É—Ä–æ–≤–µ–Ω—å`;
      rewardTag.textContent = 'Upgrade';
      burst(W.w*0.5, W.h*0.28, 140, 8.4, 140);
      confetti();
      toast(`–°—É–Ω–¥—É–∫: ${rew.upName} +1`);
    }
    save();
    applyStats();
    syncUI();
  }

  // ===== Boss AI =====
  function bossThink(dt){
    if(!boss.active || !boss.id || boss.id.hp<=0) return;

    boss.ultTimer -= dt;
    boss.spawnTimer -= dt;

    // spawn extra balls periodically
    if(boss.spawnTimer <= 0){
      boss.spawnTimer = 3.2 + rand(0,1.2);
      const baseHp = Math.max(25, Math.floor(boss.id.maxHp*0.06));
      spawnBallCluster({count: irand(2,4), baseHp, bossBall:false, groupId: irand(1,5)});
      banner('–ë–û–°–°: –≤—ã–∑–≤–∞–ª —à–∞—Ä—ã!');
      burst(boss.id.x, boss.id.y, 40, 7.0, 310);
    }

    // ult: drop bombs (hazards) + wave push (extra balls)
    if(boss.ultTimer <= 0){
      boss.ultTimer = 7.5 + rand(0,2.5);

      // bombs: 3-5
      const bombs = irand(3,5);
      for(let i=0;i<bombs;i++){
        hazards.push({
          x: rand(40, W.w-40),
          y: rand(60, 120),
          vy: rand(120, 240),
          t: 0,
          explodeT: 1.8 + rand(0,0.8),
          r: 28 + rand(0,8),
          alive:true
        });
      }

      // also spawn a couple balls
      const baseHp = Math.max(20, Math.floor(boss.id.maxHp*0.05));
      spawnBallCluster({count: irand(2,3), baseHp, bossBall:false, groupId: irand(1,5)});

      banner('–ë–û–°–°: –£–õ–¨–¢–ê!');
      toast('–ö—Ä–∞—Å–Ω—ã–µ –∫—Ä—É–≥–∏ ‚Äî —É–π–¥–∏!');
      burst(boss.id.x, boss.id.y, 70, 8.5, 340);
    }
  }

  function stepHazards(dt){
    const floor = W.h-90;
    for(let i=hazards.length-1;i>=0;i--){
      const h=hazards[i];
      h.t += dt;
      h.y += h.vy * dt;

      if(h.y + 10 >= floor){
        h.y = floor - 10;
        h.vy = 0;
      }

      // explode
      if(h.t >= h.explodeT){
        // damage zone
        const dx = player.x - h.x;
        const dy = (player.y-30) - h.y;
        if(dx*dx + dy*dy <= (h.r*h.r)){
          onLose(true); // from hazard
          hazards.splice(i,1);
          continue;
        }
        burst(h.x,h.y, 80, 9.0, 350);
        hazards.splice(i,1);
      }
    }
  }

  // ===== Run control =====
  function resetEntities(){
    bullets.length=0;
    balls.length=0;
    loot.length=0;
    powerups.length=0;
    hazards.length=0;
    particles.length=0;
    boss.active=false; boss.id=null;
  }

  function startRun(fromWave){
    resize();
    resetEntities();

    wave = Math.max(1, fromWave|0);
    player.x = W.w*0.5;
    player.y = W.h-95;
    player.targetX = null;

    buffs.shield=false;
    buffs.frenzyT=0;

    applyStats();
    spawnWave(wave);

    running=true;
    paused=false;
    awaitingChest=false;
    start.style.display='none';

    const st = stageOf(wave);
    const inS= waveInStage(wave);
    toast(`–°—Ç–∞—Ä—Ç! Stage ${st} ‚Ä¢ LvL ${inS}/${LEVELS_PER_STAGE}`);
    syncUI();
  }

  function onLose(fromHazard=false){
    // shield blocks once
    if(buffs.shield){
      buffs.shield=false;
      burst(player.x, player.y-40, 70, 7.2, 210);
      toast(fromHazard ? '–©–∏—Ç —Å–ø–∞—Å –æ—Ç –±–æ–º–±—ã üõ°' : '–©–∏—Ç —Å–ø–∞—Å! üõ°');
      syncUI();
      return;
    }

    const st = stageOf(wave);
    const backTo = stageStartWave(st);

    // rollback inside stage (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª —Ä–∞–Ω—å—à–µ)
    SAVE.bestWave = Math.max(SAVE.bestWave, wave);
    SAVE.currentWave = backTo;
    save();

    banner('–ü–†–û–ò–ì–†–ê–õ üòµ');
    confetti();
    toast(`–û—Ç–∫–∞—Ç: Stage ${st} ‚Üí LvL 1`);

    running=false;
    paused=false;
    awaitingChest=false;

    setOverlayText(
      `–ü—Ä–æ–∏–≥—Ä–∞–ª. Stage ${st}`,
      `–¢—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å—Å—è –Ω–∞ 1-–π —É—Ä–æ–≤–µ–Ω—å —ç—Ç–∞–ø–∞ (—É—Ä–æ–≤–µ–Ω—å ${backTo}). –ù–∞–∂–º–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å".`
    );
    start.style.display='flex';
    syncUI();
  }

  // ===== Simulation =====
  function sim(dt){
    // buff timers
    if(buffs.frenzyT > 0){
      buffs.frenzyT -= dt;
      if(buffs.frenzyT <= 0){
        buffs.frenzyT = 0;
        toast('–§—Ä–µ–Ω–∑–∏ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å ‚ö°');
      }
    }
    applyStats();

    // movement
    const minX = 30;
    const maxX = W.w - 30;
    if(player.targetX !== null){
      const target = clamp(player.targetX, minX, maxX);
      const follow = 0.50; // —á—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ ‚Äú–∫–∞–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª‚Äù
      player.x += (target - player.x) * follow;
    } else {
      const dir = (right()?1:0) - (left()?1:0);
      player.x += dir * 880 * dt;
    }
    player.x = clamp(player.x, minX, maxX);

    // boss thinking
    bossThink(dt);

    // hazards
    stepHazards(dt);

    // shoot
    shoot();

    // bullets
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i];
      b.x += b.vx * dt * 60;
      b.y += b.vy * dt;
      if(b.y < -60){ bullets.splice(i,1); continue; }

      for(let j=balls.length-1;j>=0;j--){
        const ball=balls[j];
        const dx = b.x - ball.x;
        const dy = b.y - ball.y;
        const rr = ball.r + b.r;
        if(dx*dx + dy*dy <= rr*rr){
          ball.hp -= b.dmg;
          const hitHue = b.crit ? 55 : (ball.boss ? 300 : 200);
          burst(b.x,b.y, b.crit?20:12, b.crit?7.2:5.0, hitHue);
          bullets.splice(i,1);

          if(ball.hp <= 0){
            // clear boss state if killed
            const wasBoss = ball.boss;
            const bx=ball.x, by=ball.y;

            balls.splice(j,1);
            splitAndLoot(ball);
            burst(bx, by, 52, 7.6, wasBoss?320:55);

            if(wasBoss){
              boss.active=false; boss.id=null;
              toast('–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù! üëë');
              confetti();
            }
          }
          break;
        }
      }
    }

    // balls physics + collision
    const g = 980;
    const floor = W.h-90;

    for(const ball of balls){
      ball.vy += g * dt * 0.001;
      ball.x += ball.vx * dt * 120;
      ball.y += ball.vy * dt * 120;

      if(ball.x-ball.r < 0){ ball.x=ball.r; ball.vx*=-0.95; }
      if(ball.x+ball.r > W.w){ ball.x=W.w-ball.r; ball.vx*=-0.95; }

      if(ball.y+ball.r > floor){
        ball.y = floor - ball.r;
        ball.vy *= -0.78;
        if(Math.abs(ball.vy) < 0.9) ball.vy = -rand(1.2, 2.0);
        ball.vx += rand(-0.08, 0.08);
        ball.vx = clamp(ball.vx, -1.9, 1.9);
      }

      // collision with player = lose
      const cx = player.x, cy = player.y - 20;
      const dx = ball.x - cx, dy = ball.y - cy;
      const rr = ball.r + 22;
      if(dx*dx + dy*dy < rr*rr){
        onLose(false);
        return;
      }
    }

    // loot physics
    const px = player.x, py = player.y-30;
    const magR = ST.magnet;

    function stepDrop(arr, onPickup){
      const lootG = 1700;
      const bounce = 0.35;
      const floorFriction = 0.82;

      for(let i=arr.length-1;i>=0;i--){
        const l=arr[i];

        // magnet
        const wantsMag = (l.type==='coin') || (l.type==='shield') || (l.type==='frenzy');
        if(magR > 0 && wantsMag){
          const dx = px - l.x, dy = py - l.y;
          const d2 = dx*dx + dy*dy;
          const mr = (l.type==='coin') ? magR : magR*0.55;
          if(d2 < mr*mr){
            l.vx += dx * 0.020 * (dt*60);
            l.vy += dy * 0.020 * (dt*60);
          }
        }

        if(!l.grounded) l.vy += lootG * dt;
        l.x += l.vx * dt;
        l.y += l.vy * dt;

        if(l.x - l.r < 0){ l.x = l.r; l.vx *= -0.45; }
        if(l.x + l.r > W.w){ l.x = W.w - l.r; l.vx *= -0.45; }

        if(l.y + l.r >= floor){
          l.y = floor - l.r;
          if(Math.abs(l.vy) > 120){
            l.vy *= -bounce;
            l.vx *= 0.88;
            l.grounded = false;
          } else {
            l.vy = 0;
            l.grounded = true;
            l.vx *= floorFriction;
            if(Math.abs(l.vx) < 8) l.vx = 0;
          }
        }

        // pickup
        const dxp = px - l.x, dyp = py - l.y;
        if(dxp*dxp + dyp*dyp < 30*30){
          onPickup(l);
          arr.splice(i,1);
        }
      }
    }

    stepDrop(loot, (l)=>{
      if(l.type==='coin'){
        // coins scaled by stage + pet buff
        const st = stageOf(wave);
        const stageMul = 1 + st*0.03;
        SAVE.coins += Math.max(1, Math.floor(1 * ST.coinMult * stageMul));
        burst(l.x,l.y, 10, 4.0, 55);
      } else {
        SAVE.gems += 1;
        burst(l.x,l.y, 14, 4.8, 290);
      }
    });

    stepDrop(powerups, (p)=>{
      if(p.type==='shield'){
        buffs.shield=true;
        burst(p.x,p.y, 36, 6.2, 210);
        toast('–©–∏—Ç üõ° (1 —Ä–∞–∑ —Å–ø–∞—Å—ë—Ç)');
      } else {
        buffs.frenzyT = Math.max(buffs.frenzyT, 9.0);
        burst(p.x,p.y, 46, 7.0, 50);
        toast('–§—Ä–µ–Ω–∑–∏ ‚ö° (—Å–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å x2)');
      }
    });

    // wave cleared
    if(balls.length===0){
      const prevWave = wave;
      const prevStage = stageOf(prevWave);
      const prevIn = waveInStage(prevWave);

      SAVE.bestWave = Math.max(SAVE.bestWave, prevWave);
      save();

      // stage complete?
      if(prevIn === LEVELS_PER_STAGE){
        nextWaveAfterChest = prevWave + 1;
        openStageChest(prevStage);

        banner(`–≠–¢–ê–ü ${prevStage} –ü–†–û–ô–î–ï–ù!`);
        confetti();

        // set progress to next stage start (so continue works even if you close on chest)
        SAVE.currentWave = nextWaveAfterChest;
        save();
        syncUI();
        return;
      }

      // normal next wave
      wave++;
      const st = stageOf(wave);
      const wIn = waveInStage(wave);

      if(wIn === 1){
        banner(isBossStage(st) ? `BOSS STAGE ${st}!` : `–≠–¢–ê–ü ${st}!`);
        confetti();
        toast(isBossStage(st) ? '–ü–æ–¥–≥–æ—Ç–æ–≤—å—Å—è –∫ –±–æ—Å—Å—É üëë' : `–ù–æ–≤—ã–π —ç—Ç–∞–ø: ${st}`);
      } else {
        banner(`–£–†–û–í–ï–ù–¨ ${wIn}/${LEVELS_PER_STAGE}`);
        toast(`–£—Ä–æ–≤–µ–Ω—å ${wIn}/${LEVELS_PER_STAGE}`);
      }

      spawnWave(wave);
    }

    save();
    syncUI();
  }

  // ===== Drawing helpers =====
  function roundRect(x,y,w,h,r){
    r=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function cannonMainColor(){
    const map = {
      blue:'#3A86FF', red:'#FF4A6B', purple:'#8E5BFF', black:'#2B2B2B',
      gold:'#DFAF2B', mint:'#39D1B1'
    };
    return map[SAVE.cannonColor] || '#3A86FF';
  }

  function drawHat(x,y){
    const hat = SAVE.hat;
    if(hat==='none') return;

    ctx.save();
    ctx.translate(x, y);

    if(hat==='cap'){
      ctx.fillStyle='rgba(0,0,0,.18)';
      ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.92)';
      roundRect(-18,-22,36,16,8); ctx.fill();
      ctx.fillStyle='rgba(0,0,0,.12)';
      roundRect(-18,-22,36,16,8); ctx.stroke();
      ctx.fillStyle='rgba(255,255,255,.85)';
      roundRect(-12,-12,24,8,6); ctx.fill();
    }
    else if(hat==='crown'){
      ctx.fillStyle='rgba(255,196,58,.95)';
      roundRect(-18,-26,36,18,8); ctx.fill();
      ctx.fillStyle='rgba(154,106,0,.25)';
      roundRect(-18,-26,36,18,8); ctx.stroke();
      ctx.fillStyle='rgba(255,255,255,.9)';
      ctx.font='900 12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('üëë', 0, -17);
    }
    else if(hat==='horns'){
      ctx.fillStyle='rgba(0,0,0,.20)';
      ctx.beginPath(); ctx.arc(-10,-18,8,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(10,-18,8,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.92)';
      ctx.beginPath(); ctx.arc(-10,-18,6,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(10,-18,6,0,Math.PI*2); ctx.fill();
    }
    else if(hat==='halo'){
      ctx.strokeStyle='rgba(255,196,58,.95)';
      ctx.lineWidth=4;
      ctx.shadowColor='rgba(255,196,58,.55)';
      ctx.shadowBlur=14;
      ctx.beginPath(); ctx.ellipse(0,-24,18,7,0,0,Math.PI*2); ctx.stroke();
    }

    ctx.restore();
  }

  function weaponStyle(){
    const id = SAVE.weaponSkin;
    // returns body color variants
    if(id==='steel') return {body:'rgba(60,60,60,.90)', accent:'rgba(255,255,255,.75)'};
    if(id==='carbon')return {body:'rgba(30,30,30,.92)', accent:'rgba(190,190,190,.70)'};
    if(id==='royal') return {body:'rgba(35,35,35,.92)', accent:'rgba(255,196,58,.92)'};
    if(id==='myth')  return {body:'rgba(25,25,35,.94)', accent:'rgba(142,91,255,.92)'};
    return {body:'rgba(60,60,60,.90)', accent:'rgba(255,255,255,.75)'};
  }

  function drawBall(ball){
    const g = GROUPS[ball.group] || GROUPS[1];

    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,.18)';
    ctx.shadowBlur = 12;

    // fill
    ctx.fillStyle = ball.boss ? 'rgba(142,91,255,.98)' : g.fill;
    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();

    ctx.shadowBlur = 0;
    // ring
    ctx.lineWidth = 2.2;
    ctx.strokeStyle = ball.boss ? 'rgba(92,31,180,.75)' : g.stroke;
    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.stroke();

    // subtle stripe for ‚Äúgroup feel‚Äù
    if(!ball.boss){
      ctx.globalAlpha = 0.20;
      ctx.strokeStyle = 'rgba(255,255,255,.9)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.r*0.62, 0.2, 2.3);
      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    // hp text
    ctx.fillStyle = 'rgba(0,0,0,.82)';
    ctx.font = `${Math.max(14, Math.floor(ball.r*0.60))}px system-ui`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(Math.max(1, Math.floor(ball.hp)), ball.x, ball.y);

    if(ball.boss){
      ctx.font = `${Math.max(18, Math.floor(ball.r*0.45))}px system-ui`;
      ctx.fillText('üëë', ball.x, ball.y - ball.r*0.78);

      // boss hp bar
      const w= Math.min(280, W.w*0.68);
      const x = W.w*0.5 - w/2;
      const y = 92 + (envSafeTop());
      const p = clamp(ball.hp/ball.maxHp, 0, 1);
      ctx.save();
      ctx.globalAlpha=0.95;
      ctx.fillStyle='rgba(0,0,0,.18)';
      roundRect(x,y,w,10,999); ctx.fill();
      ctx.fillStyle='rgba(142,91,255,.95)';
      roundRect(x,y,w*p,10,999); ctx.fill();
      ctx.restore();
    }

    ctx.restore();
  }

  function envSafeTop(){
    // rough: in canvas we can just return 0
    return 0;
  }

  function drawBullets(){
    for(const b of bullets){
      ctx.save();
      const base = b.crit ? 'rgba(255,196,58,.95)' : 'rgba(46,196,255,.95)';
      ctx.fillStyle = base;
      ctx.shadowColor = base;
      ctx.shadowBlur= (SAVE.bulletFx==='clean') ? 8 : 14;

      // FX variants
      if(SAVE.bulletFx==='trail'){
        ctx.globalAlpha=0.25;
        ctx.fillRect(b.x-1.5, b.y+10, 3, 18);
        ctx.globalAlpha=1;
      } else if(SAVE.bulletFx==='spark'){
        if(Math.random()<0.15) particles.push({x:b.x,y:b.y+8,vx:rand(-1.2,1.2),vy:rand(1.0,2.4),life:rand(12,26),kind:'spark',hue:rand(40,70),size:rand(1.6,2.6)});
      }

      ctx.beginPath(); ctx.arc(b.x,b.y,b.crit?4.1:3.2,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
  }

  function drawLoot(){
    for(const l of loot){
      ctx.save();
      if(l.type==='coin'){
        ctx.fillStyle='rgba(255,196,58,.95)';
        ctx.shadowColor='rgba(255,196,58,.55)';
        ctx.shadowBlur=12;
        ctx.beginPath(); ctx.arc(l.x,l.y,l.r,0,Math.PI*2); ctx.fill();
      } else {
        ctx.fillStyle='rgba(142,91,255,.95)';
        ctx.shadowColor='rgba(142,91,255,.55)';
        ctx.shadowBlur=14;
        ctx.beginPath();
        ctx.moveTo(l.x, l.y-l.r);
        ctx.lineTo(l.x+l.r, l.y);
        ctx.lineTo(l.x, l.y+l.r);
        ctx.lineTo(l.x-l.r, l.y);
        ctx.closePath();
        ctx.fill();
      }
      ctx.restore();
    }
  }

  function drawPowerups(){
    for(const p of powerups){
      ctx.save();
      if(p.type==='shield'){
        ctx.fillStyle='rgba(46,196,255,.95)';
        ctx.shadowColor='rgba(46,196,255,.55)';
        ctx.shadowBlur=14;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='rgba(255,255,255,.95)';
        ctx.font='900 14px system-ui';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText('üõ°', p.x, p.y+1);
      } else {
        ctx.fillStyle='rgba(255,196,58,.95)';
        ctx.shadowColor='rgba(255,196,58,.55)';
        ctx.shadowBlur=14;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='rgba(0,0,0,.75)';
        ctx.font='900 14px system-ui';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText('‚ö°', p.x, p.y+1);
      }
      ctx.restore();
    }
  }

  function drawHazards(){
    // bombs preview + red zone
    for(const h of hazards){
      const t = clamp(h.t / h.explodeT, 0, 1);
      ctx.save();

      // warning ring
      ctx.globalAlpha = 0.20 + 0.45*t;
      ctx.strokeStyle='rgba(255,74,107,.95)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(h.x, h.y, h.r*(0.8+0.35*Math.sin(t*10)), 0, Math.PI*2);
      ctx.stroke();

      // bomb core
      ctx.globalAlpha = 0.95;
      ctx.fillStyle='rgba(255,74,107,.95)';
      ctx.shadowColor='rgba(255,74,107,.55)';
      ctx.shadowBlur=14;
      ctx.beginPath(); ctx.arc(h.x, h.y, 10, 0, Math.PI*2); ctx.fill();

      // timer
      ctx.shadowBlur=0;
      ctx.fillStyle='rgba(255,255,255,.95)';
      ctx.font='900 12px system-ui';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(String(Math.max(0, Math.ceil(h.explodeT - h.t))), h.x, h.y+0.5);

      ctx.restore();
    }
  }

  function drawCannon(){
    const x=player.x, y=player.y;
    const cMain = cannonMainColor();
    const ws = weaponStyle();

    ctx.save();
    ctx.shadowColor='rgba(0,0,0,.22)';
    ctx.shadowBlur=14;

    // shield aura
    if(buffs.shield){
      ctx.save();
      ctx.globalAlpha=0.40;
      ctx.strokeStyle='rgba(46,196,255,.95)';
      ctx.lineWidth=4;
      ctx.beginPath(); ctx.arc(x, y-18, 36, 0, Math.PI*2); ctx.stroke();
      ctx.restore();
    }

    // wheels
    for(const s of [-1,1]){
      ctx.fillStyle='rgba(0,0,0,.20)';
      ctx.beginPath(); ctx.arc(x + s*18, y+14, 12, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.75)';
      ctx.beginPath(); ctx.arc(x + s*18, y+14, 6, 0, Math.PI*2); ctx.fill();
    }

    // body
    ctx.fillStyle=ws.body;
    roundRect(x-36, y-7, 72, 18, 10); ctx.fill();

    // turret base
    ctx.fillStyle=cMain;
    roundRect(x-17, y-42, 34, 34, 12); ctx.fill();

    // barrel
    ctx.fillStyle=ws.accent;
    roundRect(x-6, y-62, 12, 26, 8); ctx.fill();

    // extra barrels as you buy cannons (visual)
    const n = ST.cannons;
    if(n>=2){
      ctx.fillStyle=ws.accent;
      roundRect(x-24, y-58, 10, 20, 7); ctx.fill();
      roundRect(x+14, y-58, 10, 20, 7); ctx.fill();
    }
    if(n>=3){
      ctx.fillStyle=ws.accent;
      roundRect(x-40, y-52, 9, 18, 7); ctx.fill();
      roundRect(x+31, y-52, 9, 18, 7); ctx.fill();
    }
    if(n>=4){
      ctx.fillStyle=ws.accent;
      roundRect(x-30, y-66, 9, 18, 7); ctx.fill();
      roundRect(x+21, y-66, 9, 18, 7); ctx.fill();
    }
    if(n>=5){
      ctx.fillStyle=ws.accent;
      roundRect(x-52, y-46, 8, 16, 6); ctx.fill();
      roundRect(x+44, y-46, 8, 16, 6); ctx.fill();
    }
    if(n>=6){
      ctx.fillStyle=ws.accent;
      roundRect(x-12, y-74, 8, 18, 6); ctx.fill();
      roundRect(x+4, y-74, 8, 18, 6); ctx.fill();
    }

    // label
    ctx.shadowBlur=0;
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.font='900 12px system-ui';
    ctx.textAlign='center'; ctx.textBaseline='bottom';
    ctx.fillText(`x${ST.cannons}`, x, y-44);

    drawHat(x, y-44);

    ctx.restore();
  }

  // ===== Main draw =====
  let time=0;
  function draw(){
    resize();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.setTransform(DPR,0,0,DPR,0,0);

    drawBG(time);

    // hazards under balls? warning visible
    drawHazards();

    // balls
    for(const ball of balls) drawBall(ball);

    drawBullets();
    drawLoot();
    drawPowerups();
    drawParticles();
    drawCannon();
  }

  // ===== Loop =====
  let last=now();
  function loop(){
    const t=now();
    const dt=clamp((t-last)/1000, 0.008, 0.050);
    last=t;
    time += dt*1000;

    if(running && !paused && !anyModalOpen() && !awaitingChest){
      sim(dt);
    }

    stepParticles(dt*60);
    draw();
    requestAnimationFrame(loop);
  }

  // ===== Shop controls =====
  btnShop.addEventListener('click', ()=>{
    if(!running || awaitingChest) return;
    paused=true;
    mShop.classList.add('on');
    renderShopTab('up');
  });
  closeShop.addEventListener('click', ()=>{ mShop.classList.remove('on'); paused=false; });
  mShop.addEventListener('click', (e)=>{ if(e.target===mShop){ mShop.classList.remove('on'); paused=false; } });

  tabUp.addEventListener('click', ()=>renderShopTab('up'));
  tabWp.addEventListener('click', ()=>renderShopTab('wp'));
  tabCs.addEventListener('click', ()=>renderShopTab('cs'));

  // ===== Pets =====
  btnPets.addEventListener('click', ()=>{
    if(!running || awaitingChest) return;
    paused=true;
    mPets.classList.add('on');
    renderInv();
    syncUI();
  });
  closePets.addEventListener('click', ()=>{ mPets.classList.remove('on'); paused=false; });
  mPets.addEventListener('click', (e)=>{ if(e.target===mPets){ mPets.classList.remove('on'); paused=false; } });
  spin1.addEventListener('click', ()=>spin(25, 1));
  spin10.addEventListener('click', ()=>spin(220, 10));

  // ===== Admin =====
  btnAdmin.addEventListener('click', ()=>{
    if(!running) return;
    paused=true;
    mAdmin.classList.add('on');
    adminPass.value='';
    adminPass.focus?.();
  });
  closeAdmin.addEventListener('click', ()=>{ mAdmin.classList.remove('on'); paused=false; });
  mAdmin.addEventListener('click', (e)=>{ if(e.target===mAdmin){ mAdmin.classList.remove('on'); paused=false; } });

  btnGiveCoins.addEventListener('click', ()=>{
    if((adminPass.value||'').trim() !== ADMIN_PASSWORD) return toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚ùå');
    const add=Math.max(0, Math.floor(Number(giveCoins.value||0)));
    if(!add) return toast('–í–≤–µ–¥–∏ —á–∏—Å–ª–æ ü™ô');
    SAVE.coins += add; save(); syncUI();
    confetti(); burst(W.w*0.5, W.h*0.35, 90, 7.0, 55);
    toast(`+${add} ü™ô`);
  });
  btnGiveGems.addEventListener('click', ()=>{
    if((adminPass.value||'').trim() !== ADMIN_PASSWORD) return toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚ùå');
    const add=Math.max(0, Math.floor(Number(giveGems.value||0)));
    if(!add) return toast('–í–≤–µ–¥–∏ —á–∏—Å–ª–æ üíé');
    SAVE.gems += add; save(); syncUI();
    confetti(); burst(W.w*0.5, W.h*0.35, 90, 7.0, 290);
    toast(`+${add} üíé`);
  });
  btnAdminMax.addEventListener('click', ()=>{
    if((adminPass.value||'').trim() !== ADMIN_PASSWORD) return toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚ùå');
    for(const it of UPGRADES) SAVE.up[it.id] = it.max;
    save(); applyStats(); syncUI();
    confetti(); toast('–ê–ø–≥—Ä–µ–π–¥—ã MAX ‚úÖ');
  });
  btnAdminStage.addEventListener('click', ()=>{
    if((adminPass.value||'').trim() !== ADMIN_PASSWORD) return toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚ùå');
    // jump to next stage start
    const st = stageOf(SAVE.currentWave||1);
    const next = stageStartWave(st+1);
    SAVE.currentWave = next;
    save(); syncUI();
    toast(`Stage +1 ‚Üí Wave ${next}`);
  });
  btnAdminPet.addEventListener('click', ()=>{
    if((adminPass.value||'').trim() !== ADMIN_PASSWORD) return toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚ùå');
    const p=rollPet(); addPet(p);
    save(); applyStats(); syncUI();
    confetti(); toast(`–ü–∏—Ç–æ–º–µ—Ü: ${p.name}`);
  });

  // ===== Pause =====
  btnPause.addEventListener('click', ()=>{
    if(!running || awaitingChest) return;
    paused=!paused;
    toast(paused?'–ü–∞—É–∑–∞':'–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å');
  });

  // ===== Chest =====
  chestBtn.addEventListener('click', ()=>{
    if(chestOpened) return;
    chestOpened=true;
    chestBtn.classList.add('openAnim');

    setTimeout(()=>{
      const stage = Number(uiChestStage.textContent||1);
      const rew = rollChestReward(stage);
      rewardBox.style.display='block';
      applyChestReward(rew);
      btnChestContinue.disabled=false;
    }, 380);
  });

  btnChestContinue.addEventListener('click', ()=>{
    if(!awaitingChest) return;
    mChest.classList.remove('on');
    awaitingChest=false;
    paused=false;

    bullets.length=0;
    balls.length=0;
    loot.length=0;
    powerups.length=0;
    hazards.length=0;
    boss.active=false; boss.id=null;

    wave = nextWaveAfterChest;
    banner(isBossStage(stageOf(wave)) ? `BOSS STAGE ${stageOf(wave)}!` : `–≠–¢–ê–ü ${stageOf(wave)}!`);
    spawnWave(wave);
    toast(`Stage ${stageOf(wave)} ‚Ä¢ LvL 1/${LEVELS_PER_STAGE}`);
    syncUI();
  });

  // ===== Start overlay =====
  function startNew(){
    SAVE.currentWave = 1;
    save();
    startRun(1);
    setOverlayText('–ó–∞–∂–∞–ª ‚Üí –≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º','–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è. –ö–∞–∂–¥—ã–π 5-–π —ç—Ç–∞–ø ‚Äî –ë–û–°–° üëë');
  }
  function continueGame(){
    const w = Math.max(1, Number(SAVE.currentWave||1));
    startRun(w);
    setOverlayText('–ó–∞–∂–∞–ª ‚Üí –≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º','–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ‚úÖ');
  }

  btnStart.addEventListener('click', (e)=>{ e.preventDefault(); startNew(); });
  btnContinue.addEventListener('click', (e)=>{ e.preventDefault(); continueGame(); });
  btnReset.addEventListener('click', ()=>hardReset());

  start.addEventListener('click', (e)=>{
    if(e.target===btnReset || e.target===btnStart || e.target===btnContinue) return;
    // tap anywhere: continue if exists else new
    if(SAVE.currentWave && SAVE.currentWave>1) continueGame();
    else startNew();
  }, {passive:true});

  // ===== Initial overlay state =====
  function refreshStartOverlay(){
    const st = stageOf(SAVE.currentWave||1);
    const wIn = waveInStage(SAVE.currentWave||1);
    if(SAVE.currentWave && SAVE.currentWave>1){
      setOverlayText('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É?', `–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: Stage ${st} ‚Ä¢ LvL ${wIn}/${LEVELS_PER_STAGE}. –ù–∞–∂–º–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å".`);
    } else {
      setOverlayText('–ó–∞–∂–∞–ª ‚Üí –≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º', '–≠—Ç–∞–ø = 5 —É—Ä–æ–≤–Ω–µ–π. –ö–∞–∂–¥—ã–π 5-–π —ç—Ç–∞–ø ‚Äî –ë–û–°–°. –°—É–Ω–¥—É–∫ –ø–æ—Å–ª–µ —ç—Ç–∞–ø–∞ üéÅ');
    }
  }

  // ===== Init =====
  applyStats();
  syncUI();
  refreshStartOverlay();
  toast('–û—Ç–∫—Ä—ã–≤–∞–π Shop ‚Üí –º–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ üòà');
  loop();

})();
</script>
</body>
            </html>
