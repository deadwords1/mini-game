<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Neon Jump</title>
  <style>
    :root{
      --bg1:#0b0f1a; --bg2:#121a2b;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --neo:#8C7CFF; --neo2:#4CE6FF; --gold:#FFD76A;
      --bad:#FF4E78; --warn:#FFD37C; --good:#7CFFB2;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; overflow:hidden;
      background:
        radial-gradient(1200px 700px at 20% 10%, #1a1f3a, transparent 60%),
        radial-gradient(900px 600px at 85% 25%, #123a4a, transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .frame{
      position:fixed; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      touch-action:none;
      overflow:hidden;
    }
    canvas{width:100%; height:100%; display:block; touch-action:none;}

    .hud{
      position:absolute; left:0; right:0; top:0;
      padding: max(8px, env(safe-area-inset-top)) 10px 0 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      pointer-events:none;
      z-index:5;
    }
    .pill{
      pointer-events:none;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px 12px; min-height:40px;
      border-radius:999px;
      background:var(--panel);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      font-weight:900; letter-spacing:.2px;
    }
    .pill small{font-weight:800; color:var(--muted)}
    .btns{display:flex; gap:10px; pointer-events:auto}
    .btn{
      height:40px;
      padding:0 12px;
      border-radius:16px;
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border:1px solid var(--stroke);
      color:var(--text);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      font-weight:1000;
      display:flex; align-items:center; justify-content:center; gap:8px;
      user-select:none; cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition:.12s transform ease, .12s filter ease;
    }
    .btn:active{transform: translateY(1px) scale(.99); filter:brightness(.95)}
    .dot{width:9px;height:9px;border-radius:50%;background:var(--neo2); box-shadow:0 0 14px rgba(76,230,255,.7)}

    .toast{
      position:absolute; left:50%;
      bottom: max(10px, env(safe-area-inset-bottom));
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      font-size: 13px;
      pointer-events:none;
      opacity:0;
      transition:.18s opacity ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      max-width: calc(100% - 24px);
      text-align:center;
      line-height:1.25;
      z-index:6;
    }
    .toast.on{opacity:1}

    .record{
      position:absolute; left:50%;
      top: calc(56px + max(8px, env(safe-area-inset-top)));
      transform:translateX(-50%) scale(.9);
      padding:12px 16px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(140,124,255,.28), rgba(76,230,255,.14));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 22px 70px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      font-weight:1000;
      letter-spacing:.6px;
      opacity:0;
      z-index:7;
      pointer-events:none;
    }
    .record.on{ animation: pop 1.25s ease forwards; }
    @keyframes pop{
      0%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.88)}
      20%{opacity:1; transform:translateX(-50%) translateY(0px) scale(1.02)}
      55%{opacity:1; transform:translateX(-50%) translateY(0px) scale(1)}
      100%{opacity:0; transform:translateX(-50%) translateY(-10px) scale(.96)}
    }

    /* Start overlay */
    .start{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:8;
      background: radial-gradient(700px 400px at 50% 30%, rgba(76,230,255,.10), transparent 60%),
                  rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      padding:16px;
    }
    .startCard{
      width:min(520px, 100%);
      border-radius:24px;
      background: linear-gradient(180deg, rgba(18,26,43,.92), rgba(10,14,25,.92));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.60);
      padding:16px;
      text-align:center;
    }
    .startCard h1{
      margin:6px 0 8px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .startCard p{
      margin:0 0 12px;
      color:rgba(255,255,255,.75);
      line-height:1.35;
      font-size:13px;
    }
    .bigBtn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px;
      border-radius:18px;
      background: linear-gradient(180deg, rgba(140,124,255,.28), rgba(76,230,255,.14));
      border:1px solid rgba(255,255,255,.16);
      font-weight:1000;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .bigBtn:active{filter:brightness(.95); transform:translateY(1px)}

    /* Error overlay */
    .err{
      position:absolute; left:10px; right:10px;
      top: calc(60px + max(8px, env(safe-area-inset-top)));
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255, 60, 90, .22);
      border:1px solid rgba(255, 60, 90, .38);
      color: rgba(255,255,255,.92);
      font-size:12px;
      line-height:1.35;
      z-index:99;
      display:none;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
    }
    .err b{display:block; margin-bottom:6px}

    /* Shop bottom sheet */
    .modal{
      position:absolute; inset:0;
      display:none;
      align-items:flex-end; justify-content:center;
      padding: 10px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index:20;
    }
    .modal.on{display:flex}
    .sheet{
      width:min(880px, 100%);
      max-height: calc(100% - max(18px, env(safe-area-inset-top)));
      overflow:hidden;
      border-radius:22px;
      background: linear-gradient(180deg, rgba(18,26,43,.94), rgba(10,14,25,.94));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.60);
      display:flex;
      flex-direction:column;
    }
    .sheetTop{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(18,26,43,.98), rgba(18,26,43,.70));
    }
    .sheetTop h2{margin:0; font-size:16px; letter-spacing:.2px}
    .coinsPill{
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      font-weight:1000;
      display:flex; gap:8px; align-items:center;
    }
    .sheetBody{
      padding:12px 14px 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .tabs{display:flex; gap:10px; margin-bottom:12px;}
    .tab{
      flex:1;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.85);
      font-weight:1000;
      text-align:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.on{
      background: linear-gradient(180deg, rgba(140,124,255,.22), rgba(76,230,255,.10));
      border-color: rgba(255,255,255,.16);
      color: rgba(255,255,255,.95);
      box-shadow: 0 16px 50px rgba(0,0,0,.35);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width:720px){ .grid{grid-template-columns:1fr;} }
    .item{
      padding:12px; border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      display:flex; flex-direction:column; gap:8px;
    }
    .head{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .tag{font-size:12px; color:rgba(255,255,255,.75); padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05)}
    .price{font-weight:1000; color:var(--gold); text-shadow:0 0 16px rgba(255,215,106,.25)}
    .muted{color:var(--muted); font-size:12.5px; line-height:1.35}
    .rowBtns{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:2px;}
    .mini{
      padding:9px 10px; border-radius:12px;
      background: linear-gradient(180deg, rgba(140,124,255,.25), rgba(76,230,255,.14));
      border:1px solid rgba(255,255,255,.14);
      color:var(--text); font-weight:1000;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .mini:active{transform: translateY(1px) scale(.99); filter:brightness(.95)}
    .mini:disabled{opacity:.45}
    .equip{ background: linear-gradient(180deg, rgba(124,255,178,.18), rgba(255,215,106,.12)); }
  </style>
</head>
<body>
  <div class="frame">
    <canvas id="c"></canvas>

    <div class="hud">
      <div class="pill">
        <span>‚¨ÜÔ∏è <small>–í—ã—Å–æ—Ç–∞</small> <span id="uiScore">0</span></span>
        <span>ü™ô <small>–ú–æ–Ω–µ—Ç—ã</small> <span id="uiCoins">0</span></span>
        <span>üèÜ <small>–†–µ–∫–æ—Ä–¥</small> <span id="uiBest">0</span></span>
      </div>
      <div class="btns">
        <div class="btn" id="btnShop"><span class="dot"></span>Shop</div>
        <div class="btn" id="btnRestart"><span class="dot" style="background:var(--bad)"></span>‚Üª</div>
      </div>
    </div>

    <div class="record" id="recordBanner">üî• –ù–û–í–´–ô –†–ï–ö–û–†–î!</div>
    <div class="toast" id="toast"></div>
    <div class="err" id="err"></div>

    <div class="start" id="start">
      <div class="startCard">
        <div style="font-weight:1000; letter-spacing:.6px; color:rgba(255,255,255,.85)">NEON JUMP</div>
        <h1>–¢–∞–ø–Ω–∏ –∏ –≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º</h1>
        <p>–ö–≤–∞–¥—Ä–∞—Ç–∏–∫ —Å–∞–º –ø—Ä—ã–≥–∞–µ—Ç. –¢—ã –ø—Ä–æ—Å—Ç–æ –¥–≤–∏–≥–∞–µ—à—å –µ–≥–æ –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –ø–∞–ª—å—Ü–µ–º.<br>–°–æ–±–∏—Ä–∞–π –º–æ–Ω–µ—Ç—ã, –ø–æ–∫—É–ø–∞–π –∫–æ—Å–º–µ—Ç–∏–∫—É –∏ –∞–ø–≥—Ä–µ–π–¥—ã.</p>
        <div class="bigBtn" id="btnStart">‚ñ∂ –°—Ç–∞—Ä—Ç</div>
      </div>
    </div>

    <div class="modal" id="modal">
      <div class="sheet">
        <div class="sheetTop">
          <div>
            <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
            <div class="muted" style="margin-top:4px">–ê–ø–≥—Ä–µ–π–¥—ã + –∫–æ—Å–º–µ—Ç–∏–∫–∞ (—Ü–≤–µ—Ç–∞/—à–∞–ø–∫–∏/—Ç—Ä–µ–π–ª—ã).</div>
          </div>
          <div style="display:flex; gap:10px; align-items:center">
            <div class="coinsPill">ü™ô <span id="uiCoins2">0</span></div>
            <div class="btn" id="btnClose"><span class="dot"></span>–ó–∞–∫—Ä—ã—Ç—å</div>
          </div>
        </div>
        <div class="sheetBody">
          <div class="tabs">
            <div class="tab on" id="tabUp">–ê–ø–≥—Ä–µ–π–¥—ã</div>
            <div class="tab" id="tabCos">–ö–æ—Å–º–µ—Ç–∏–∫–∞</div>
          </div>
          <div class="grid" id="grid"></div>
        </div>
      </div>
    </div>

  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  const canvas = $('c');
  const ctx = canvas.getContext('2d', { alpha:true });

  const uiScore = $('uiScore');
  const uiCoins = $('uiCoins');
  const uiBest  = $('uiBest');
  const uiCoins2= $('uiCoins2');

  const toastEl = $('toast');
  const recordBanner = $('recordBanner');
  const errEl = $('err');

  const startOverlay = $('start');
  const btnStart = $('btnStart');

  const modal = $('modal');
  const btnShop = $('btnShop');
  const btnRestart = $('btnRestart');
  const btnClose = $('btnClose');
  const grid = $('grid');
  const tabUp = $('tabUp');
  const tabCos = $('tabCos');

  // ===== Error catcher (so you SEE why) =====
  function showErr(title, msg){
    errEl.style.display = 'block';
    errEl.innerHTML = `<b>${title}</b>${String(msg).replace(/[<>]/g,'')}`;
  }
  window.addEventListener('error', (e)=>showErr('JS –æ—à–∏–±–∫–∞:', e.message || e.error || 'unknown'));
  window.addEventListener('unhandledrejection', (e)=>showErr('Promise –æ—à–∏–±–∫–∞:', e.reason || 'unknown'));

  // ===== Utils =====
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>a+Math.random()*(b-a);
  const irand=(a,b)=>Math.floor(rand(a,b+1));
  const now=()=>performance.now();

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('on');
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.classList.remove('on'), 1400);
  }

  function showRecord(){
    recordBanner.classList.remove('on');
    void recordBanner.offsetWidth;
    recordBanner.classList.add('on');
  }

  // ===== Resize =====
  const world = { w: 360, h: 640 };
  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width  = Math.floor(r.width * DPR);
    canvas.height = Math.floor(r.height * DPR);
    world.w = r.width;
    world.h = r.height;
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  // ===== Save =====
  const SAVE_KEY = 'neon_jump_save_v3_stable';
  const defaultSave = ()=>({
    coins:0,
    best:0,
    upgrades:{ speed:0, jump:0, shield:0, magnet:0 },
    cosmetics:{
      ownedColors:['neo'], ownedHats:['none'], ownedTrails:['none'],
      color:'neo', hat:'none', trail:'none'
    }
  });
  function loadSave(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return defaultSave();
      const s = JSON.parse(raw);
      const b = defaultSave();
      s.coins = Number(s.coins ?? b.coins) || 0;
      s.best  = Number(s.best  ?? b.best)  || 0;
      s.upgrades = {...b.upgrades, ...(s.upgrades||{})};
      s.cosmetics = {...b.cosmetics, ...(s.cosmetics||{})};
      s.cosmetics.ownedColors = Array.isArray(s.cosmetics.ownedColors) ? s.cosmetics.ownedColors : b.cosmetics.ownedColors.slice();
      s.cosmetics.ownedHats   = Array.isArray(s.cosmetics.ownedHats)   ? s.cosmetics.ownedHats   : b.cosmetics.ownedHats.slice();
      s.cosmetics.ownedTrails = Array.isArray(s.cosmetics.ownedTrails) ? s.cosmetics.ownedTrails : b.cosmetics.ownedTrails.slice();
      return s;
    }catch{ return defaultSave(); }
  }
  let SAVE = loadSave();
  const saveNow = ()=>localStorage.setItem(SAVE_KEY, JSON.stringify(SAVE));
  function ensureOwned(){
    if (!SAVE.cosmetics.ownedColors.includes('neo')) SAVE.cosmetics.ownedColors.push('neo');
    if (!SAVE.cosmetics.ownedHats.includes('none')) SAVE.cosmetics.ownedHats.push('none');
    if (!SAVE.cosmetics.ownedTrails.includes('none')) SAVE.cosmetics.ownedTrails.push('none');
  }
  ensureOwned();
  saveNow();

  // ===== Shop data =====
  const UPGRADE_ITEMS = [
    {id:'speed', name:'–°–∫–æ—Ä–æ—Å—Ç—å', tag:'–ö–æ–Ω—Ç—Ä–æ–ª—å', desc:'–ë—ã—Å—Ç—Ä–µ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞–ª—å—Ü—É.', base:70, scale:1.6, max:6},
    {id:'jump',  name:'–ü—Ä—ã–∂–æ–∫',   tag:'–í—ã—Å–æ—Ç–∞',   desc:'–°–∏–ª—å–Ω–µ–µ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ.', base:90, scale:1.7, max:6},
    {id:'shield',name:'–©–∏—Ç',      tag:'–°–µ–π–≤',     desc:'+1 –∂–∏–∑–Ω—å –µ—Å–ª–∏ —É–ø–∞–ª –≤–Ω–∏–∑.', base:180, scale:2.0, max:3},
    {id:'magnet',name:'–ú–∞–≥–Ω–∏—Ç',   tag:'–§–∞—Ä–º',     desc:'–ú–æ–Ω–µ—Ç—ã —Ç—è–Ω—É—Ç—Å—è –∫ —Ç–µ–±–µ.', base:110, scale:1.75, max:5},
  ];
  const COLORS = [
    {id:'neo',   name:'Neon',  price:0,   hex:'#8C7CFF', tag:'–ë–∞–∑–∞'},
    {id:'cyan',  name:'Cyan',  price:60,  hex:'#4CE6FF', tag:'–•–æ–ª–æ–¥'},
    {id:'gold',  name:'Gold',  price:120, hex:'#FFD76A', tag:'–õ—é–∫—Å'},
    {id:'pink',  name:'Pink',  price:140, hex:'#FF7C9C', tag:'–ö–∞–π—Ñ'},
    {id:'mint',  name:'Mint',  price:150, hex:'#7CFFB2', tag:'Fresh'},
    {id:'white', name:'White', price:180, hex:'#F2F5FF', tag:'–ß–∏—Å—Ç–æ'},
  ];
  const HATS = [
    {id:'none',  name:'–ë–µ–∑ —à–∞–ø–∫–∏', price:0,   tag:'–ë–∞–∑–∞'},
    {id:'cap',   name:'–ö–µ–ø–∫–∞',     price:120, tag:'Street'},
    {id:'crown', name:'–ö–æ—Ä–æ–Ω–∞',    price:220, tag:'Boss'},
    {id:'horns', name:'–†–æ–≥–∞',      price:240, tag:'Demon'},
  ];
  const TRAILS = [
    {id:'none',  name:'–ë–µ–∑ —Å–ª–µ–¥–∞',  price:0,   tag:'–ë–∞–∑–∞'},
    {id:'spark', name:'–ò—Å–∫—Ä—ã',      price:150, tag:'FX'},
    {id:'neon',  name:'–ù–µ–æ–Ω-—Å–ª–µ–¥',  price:220, tag:'FX+'},
  ];

  const up=(id)=>SAVE.upgrades[id]||0;
  const upgradeCost=(item)=>Math.floor(item.base * Math.pow(item.scale, up(item.id)));

  let shopMode='up';
  function syncUI(){
    uiScore.textContent = Math.floor(score);
    uiCoins.textContent = SAVE.coins;
    uiCoins2.textContent= SAVE.coins;
    uiBest.textContent  = Math.floor(SAVE.best || 0);
  }

  function buy(cost){
    if (SAVE.coins < cost) return false;
    SAVE.coins -= cost;
    return true;
  }

  // ===== Particles =====
  const particles = [];
  function spawnBurst(x,y, count=40, power=6){
    for(let i=0;i<count;i++){
      const a = rand(0, Math.PI*2);
      const s = rand(1.5, power);
      particles.push({
        x,y, vx:Math.cos(a)*s, vy:Math.sin(a)*s - rand(0,1.2),
        life: rand(28,56), size: rand(2,3.8),
        kind:'spark', hue: rand(0,360)
      });
    }
  }
  function spawnConfetti(){
    for(let i=0;i<90;i++){
      particles.push({
        x: rand(0,world.w),
        y: rand(-30, 30),
        vx: rand(-1.5,1.5),
        vy: rand(1.0,3.2),
        life: rand(80,130),
        size: rand(2.2,4.2),
        kind:'confetti',
        hue: rand(0,360),
        rot: rand(0,Math.PI*2),
        vr: rand(-0.2,0.2)
      });
    }
  }
  function fireworksPurchase(){
    spawnBurst(rand(world.w*0.25, world.w*0.75), rand(world.h*0.25, world.h*0.55), 55, 6.5);
    spawnBurst(rand(world.w*0.25, world.w*0.75), rand(world.h*0.25, world.h*0.55), 45, 6.0);
  }
  function stepParticles(dt){
    for (let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.life -= dt;
      if (p.life<=0){ particles.splice(i,1); continue; }

      if (p.kind==='spark' || p.kind==='trail'){
        p.vy += 0.10*dt;
        p.x += p.vx*dt;
        p.y += p.vy*dt;
        p.vx *= 0.98;
        p.vy *= 0.98;
      } else {
        p.vy += 0.03*dt;
        p.x += p.vx*dt;
        p.y += p.vy*dt;
        p.rot += (p.vr||0)*dt;
      }
    }
  }
  function drawParticles(){
    for (const p of particles){
      if (p.kind==='spark' || p.kind==='trail'){
        ctx.save();
        const a = clamp(p.life/60, 0, 1);
        ctx.globalAlpha = 0.9*a;
        ctx.fillStyle = `hsla(${p.hue}, 95%, 65%, 1)`;
        ctx.shadowColor = `hsla(${p.hue}, 95%, 65%, .65)`;
        ctx.shadowBlur = 12;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        ctx.restore();
      } else {
        ctx.save();
        const a = clamp(p.life/130, 0, 1);
        ctx.globalAlpha = 0.95*a;
        ctx.translate(p.x,p.y);
        ctx.rotate(p.rot||0);
        ctx.fillStyle = `hsla(${p.hue}, 95%, 65%, 1)`;
        ctx.fillRect(-p.size, -p.size*0.6, p.size*2, p.size*1.2);
        ctx.restore();
      }
    }
  }

  // ===== Game params =====
  const stats = { speed:6.2, jump:16.0, gravity:0.62, magnet:0, lives:0 };
  function applyUpgrades(){
    stats.speed = 6.2 + up('speed')*0.95;
    stats.jump  = 16.0 + up('jump')*1.2;
    stats.magnet= 0 + up('magnet')*55;
    stats.lives = up('shield');
  }
  applyUpgrades();

  const player = { x:0, y:0, w:28, h:28, vx:0, vy:0, targetX:null };

  let platforms=[], coins=[];
  let score=0, bestRun=0, cameraY=0, lives=0;
  let newRecordTriggered=false;

  function makePlatform(x,y,w,type){
    return { x,y,w,h:14,type, vx:(type==='move'?(Math.random()<0.5?-1:1)*rand(0.7,1.6):0), broken:false };
  }
  function spawnChunk(targetY, diff){
    const pad=18;
    const w = clamp(irand(85,150) - Math.floor(diff*20), 70, 160);
    const x = irand(pad, Math.max(pad, Math.floor(world.w - w - pad)));

    const moveChance  = 0.10 + diff*0.10;
    const breakChance = 0.10 + diff*0.18;
    const r = Math.random();
    let type='normal';
    if (r < moveChance) type='move';
    else if (r < moveChance + breakChance) type='break';

    platforms.push(makePlatform(x,targetY,w,type));

    if (Math.random()<0.58){
      const n=irand(1,4);
      for(let i=0;i<n;i++){
        coins.push({x:x+w/2+(i-(n-1)/2)*18, y:targetY-22, r:8, taken:false});
      }
    }
  }

  function resetGame(){
    resize(); // –≤–∞–∂–Ω–æ!
    applyUpgrades();
    player.x = world.w/2 - player.w/2;
    player.y = world.h*0.65;
    player.vx = 0; player.vy = -stats.jump*0.8;
    player.targetX = null;

    score=0; bestRun=0; cameraY=0;
    lives = stats.lives;
    newRecordTriggered=false;

    platforms=[]; coins=[];
    platforms.push(makePlatform(world.w/2-70, world.h-90, 140, 'normal'));

    let y = world.h - 160;
    for(let i=0;i<26;i++){
      const diff=i/26;
      y -= irand(55,88) + diff*30;
      spawnChunk(y,diff);
    }
    syncUI();
  }

  // ===== Controls (finger follow) =====
  function clientXToWorldX(clientX){
    const r = canvas.getBoundingClientRect();
    return (clientX - r.left) * (world.w / r.width);
  }

  let dragging=false, pid=null;
  canvas.addEventListener('pointerdown', (e)=>{
    if (modal.classList.contains('on')) return;
    dragging=true; pid=e.pointerId;
    try{ canvas.setPointerCapture(pid); }catch{}
    const x = clientXToWorldX(e.clientX);
    player.targetX = x - player.w/2;
  }, {passive:false});

  canvas.addEventListener('pointermove', (e)=>{
    if (!dragging || e.pointerId!==pid) return;
    const x = clientXToWorldX(e.clientX);
    player.targetX = x - player.w/2;
  }, {passive:false});

  function endDrag(e){
    if (e.pointerId!==pid) return;
    dragging=false; pid=null;
    player.targetX = null;
  }
  canvas.addEventListener('pointerup', endDrag, {passive:false});
  canvas.addEventListener('pointercancel', endDrag, {passive:false});

  // ===== Shop =====
  function renderShop(){
    syncUI();
    grid.innerHTML='';

    if (shopMode==='up'){
      for (const item of UPGRADE_ITEMS){
        const lvl = up(item.id);
        const maxed = lvl>=item.max;
        const price = upgradeCost(item);

        const el=document.createElement('div');
        el.className='item';
        el.innerHTML=`
          <div class="head">
            <div>
              <div style="font-weight:1000">${item.name} <span style="color:rgba(255,255,255,.55)">LVL ${lvl}/${item.max}</span></div>
              <div style="height:6px"></div>
              <span class="tag">${item.tag}</span>
            </div>
            <div class="price">ü™ô ${maxed?'MAX':price}</div>
          </div>
          <div class="muted">${item.desc}</div>
          <div class="rowBtns">
            <div class="muted">${maxed?'–£–∂–µ –∫—É–ø–ª–µ–Ω–æ.':(SAVE.coins>=price?'–î–æ—Å—Ç—É–ø–Ω–æ ‚úÖ':'–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ü•≤')}</div>
            <button class="mini" ${maxed||SAVE.coins<price?'disabled':''}>–ö—É–ø–∏—Ç—å</button>
          </div>
        `;
        el.querySelector('button').addEventListener('click', ()=>{
          if (maxed) return;
          const cost = upgradeCost(item);
          if (!buy(cost)) return;
          SAVE.upgrades[item.id]=lvl+1;
          applyUpgrades();
          saveNow();
          fireworksPurchase();
          toast(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}`);
          renderShop();
        });
        grid.appendChild(el);
      }
      return;
    }

    function sectionTitle(t){
      const h=document.createElement('div');
      h.style.cssText='grid-column:1/-1;margin:4px 0 -2px;font-weight:1000;';
      h.textContent=t;
      grid.appendChild(h);
    }

    function renderCos(list, kind){
      for (const it of list){
        const ownArr =
          kind==='color' ? SAVE.cosmetics.ownedColors :
          kind==='hat'   ? SAVE.cosmetics.ownedHats :
                           SAVE.cosmetics.ownedTrails;

        const owned = ownArr.includes(it.id);
        const equipped =
          kind==='color' ? SAVE.cosmetics.color===it.id :
          kind==='hat'   ? SAVE.cosmetics.hat===it.id :
                           SAVE.cosmetics.trail===it.id;

        const el=document.createElement('div');
        el.className='item';
        el.innerHTML=`
          <div class="head">
            <div>
              <div style="font-weight:1000;display:flex;align-items:center;gap:10px">
                ${it.name}
                ${kind==='color' ? `<span style="width:14px;height:14px;border-radius:6px;background:${it.hex};border:1px solid rgba(255,255,255,.18)"></span>` : ''}
              </div>
              <div style="height:6px"></div>
              <span class="tag">${it.tag}</span>
            </div>
            <div class="price">ü™ô ${it.price}</div>
          </div>
          <div class="muted">${owned ? (equipped?'–°–µ–π—á–∞—Å —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ':'–ö—É–ø–ª–µ–Ω–æ. –ú–æ–∂–Ω–æ —ç–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å.') : '–ù–µ –∫—É–ø–ª–µ–Ω–æ.'}</div>
          <div class="rowBtns">
            <div class="muted">${owned ? '–í –Ω–∞–ª–∏—á–∏–∏.' : (SAVE.coins>=it.price?'–î–æ—Å—Ç—É–ø–Ω–æ ‚úÖ':'–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ü•≤')}</div>
            <div style="display:flex;gap:8px">
              <button class="mini buyBtn" ${owned||SAVE.coins<it.price?'disabled':''}>–ö—É–ø–∏—Ç—å</button>
              <button class="mini equip equipBtn" ${!owned||equipped?'disabled':''}>–≠–∫–∏–ø</button>
            </div>
          </div>
        `;
        el.querySelector('.buyBtn').addEventListener('click', ()=>{
          if (owned) return;
          if (!buy(it.price)) return;
          ownArr.push(it.id);
          if (kind==='color') SAVE.cosmetics.color=it.id;
          if (kind==='hat')   SAVE.cosmetics.hat=it.id;
          if (kind==='trail') SAVE.cosmetics.trail=it.id;
          saveNow();
          fireworksPurchase();
          toast(`–ö—É–ø–ª–µ–Ω–æ: ${it.name}`);
          renderShop();
        });
        el.querySelector('.equipBtn').addEventListener('click', ()=>{
          if (!owned || equipped) return;
          if (kind==='color') SAVE.cosmetics.color=it.id;
          if (kind==='hat')   SAVE.cosmetics.hat=it.id;
          if (kind==='trail') SAVE.cosmetics.trail=it.id;
          saveNow();
          toast(`–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ: ${it.name}`);
          renderShop();
        });
        grid.appendChild(el);
      }
    }

    sectionTitle('–¶–≤–µ—Ç–∞');  renderCos(COLORS,'color');
    sectionTitle('–®–∞–ø–∫–∏');  renderCos(HATS,'hat');
    sectionTitle('–¢—Ä–µ–π–ª—ã'); renderCos(TRAILS,'trail');
  }

  tabUp.addEventListener('click', ()=>{ shopMode='up'; tabUp.classList.add('on'); tabCos.classList.remove('on'); renderShop(); });
  tabCos.addEventListener('click', ()=>{ shopMode='cos'; tabCos.classList.add('on'); tabUp.classList.remove('on'); renderShop(); });

  function openShop(){ modal.classList.add('on'); renderShop(); }
  function closeShop(){ modal.classList.remove('on'); }
  btnShop.addEventListener('click', openShop);
  btnClose.addEventListener('click', closeShop);
  modal.addEventListener('click', (e)=>{ if (e.target===modal) closeShop(); });

  // ===== Drawing helpers =====
  function roundRect(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y, x+w,y+h, r);
    ctx.arcTo(x+w,y+h, x,y+h, r);
    ctx.arcTo(x,y+h, x,y, r);
    ctx.arcTo(x,y, x+w,y, r);
    ctx.closePath();
  }
  function getPlayerColor(){
    const id = SAVE.cosmetics.color || 'neo';
    return (id==='neo') ? '#8C7CFF' : (COLORS.find(c=>c.id===id)?.hex || '#8C7CFF');
  }

  // ===== Physics =====
  function aabb(ax,ay,aw,ah, bx,by,bw,bh){
    return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;
  }
  function onLand(p){
    if (p.type==='break'){
      p.broken=true;
      player.vy = -stats.jump*0.85;
      spawnBurst(player.x+player.w/2, player.y+player.h, 20, 4.2);
    } else {
      player.vy = -stats.jump;
    }
  }

  function step(dt){
    // follow finger smoothly
    if (player.targetX !== null){
      const dx = (player.targetX - player.x);
      player.vx += dx * 0.035 * dt;
      player.vx = clamp(player.vx, -stats.speed*1.4, stats.speed*1.4);
    }
    player.vx *= Math.pow(0.86, dt);
    player.vx = clamp(player.vx, -stats.speed, stats.speed);
    player.x += player.vx * dt;

    // wrap
    if (player.x < -player.w) player.x = world.w;
    if (player.x > world.w) player.x = -player.w;

    // gravity
    player.vy += stats.gravity * dt;
    player.y += player.vy * dt;

    // moving platforms
    for (const p of platforms){
      if (p.type==='move'){
        p.x += p.vx * 2.2 * dt;
        if (p.x < 10){ p.x=10; p.vx*=-1; }
        if (p.x+p.w > world.w-10){ p.x=world.w-10-p.w; p.vx*=-1; }
      }
    }

    // collide when falling
    if (player.vy > 0){
      for (const p of platforms){
        if (p.broken) continue;
        const feetY = player.y + player.h;
        const prevFeetY = feetY - player.vy * dt;
        const withinX = player.x + player.w > p.x && player.x < p.x + p.w;
        const crossed = prevFeetY <= p.y && feetY >= p.y;
        const closeY = Math.abs((player.y + player.h) - p.y) < 18;
        if (withinX && crossed && closeY){
          player.y = p.y - player.h;
          onLand(p);
          break;
        }
      }
    }

    // camera up only
    const upperLine = world.h * 0.38;
    if (player.y < upperLine){
      const dy = (upperLine - player.y);
      player.y = upperLine;
      cameraY += dy;

      for (const p of platforms) p.y += dy;
      for (const c of coins) c.y += dy;

      // trails
      const trail = SAVE.cosmetics.trail || 'none';
      if (trail !== 'none'){
        const tx = player.x + player.w/2;
        const ty = player.y + player.h;
        const count = (trail==='spark') ? 2 : 3;
        for(let i=0;i<count;i++){
          particles.push({
            x: tx + rand(-6,6),
            y: ty + rand(0,6),
            vx: rand(-0.6,0.6),
            vy: rand(0.8,2.0),
            life: rand(18,28),
            size: rand(2.0,3.2),
            kind:'trail',
            hue: (trail==='neon') ? 200 : 55
          });
        }
      }
    }

    score = Math.max(score, cameraY);
    bestRun = Math.max(bestRun, score);

    // new record
    if (!newRecordTriggered && bestRun > (SAVE.best||0) + 2){
      newRecordTriggered = true;
      showRecord();
      spawnConfetti();
      toast('–ù–û–í–´–ô –†–ï–ö–û–†–î! üèÜ');
    }

    // coins
    const cx = player.x + player.w/2;
    const cy = player.y + player.h/2;
    for (const c of coins){
      if (c.taken) continue;

      if (stats.magnet > 0){
        const dx = c.x - cx, dy = c.y - cy;
        const d2 = dx*dx + dy*dy;
        if (d2 < stats.magnet*stats.magnet){
          c.x -= dx * 0.10 * dt;
          c.y -= dy * 0.10 * dt;
        }
      }

      if (aabb(player.x, player.y, player.w, player.h, c.x-c.r, c.y-c.r, c.r*2, c.r*2)){
        c.taken = true;
        SAVE.coins += 1;
        spawnBurst(c.x, c.y, 10, 3.6);
      }
    }

    // cleanup & spawn
    platforms = platforms.filter(p => p.y < world.h + 140 && !(p.broken && p.y > world.h + 40));
    coins = coins.filter(c => !c.taken && c.y < world.h + 160);

    let minY = Infinity;
    for (const p of platforms) minY = Math.min(minY, p.y);

    while (minY > -240){
      const diff = clamp(score / 2800, 0, 1);
      minY -= irand(58, 92) + diff*34;
      spawnChunk(minY, diff);
    }

    // fall
    if (player.y > world.h + 100){
      if (lives > 0){
        lives -= 1;
        toast(`–©–∏—Ç —Å–ø–∞—Å! –û—Å—Ç–∞–ª–æ—Å—å: ${lives}`);
        player.y = world.h * 0.45;
        player.vy = -stats.jump * 0.9;
        spawnBurst(world.w*0.5, world.h*0.35, 35, 5.5);
      } else {
        SAVE.best = Math.max(SAVE.best||0, Math.floor(bestRun));
        saveNow();
        resetGame();
        toast('–†–µ—Å—Ç–∞—Ä—Ç üòµ');
      }
    }

    SAVE.best = Math.max(SAVE.best||0, Math.floor(bestRun));
    saveNow();
    syncUI();
  }

  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.setTransform(DPR,0,0,DPR,0,0);

    // bg grid
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = 'rgba(255,255,255,.03)';
    for (let gx=0; gx<world.w; gx+=28) ctx.fillRect(gx, 0, 1, world.h);
    for (let gy=0; gy<world.h; gy+=28) ctx.fillRect(0, gy, world.w, 1);
    ctx.restore();

    // stars
    ctx.save();
    ctx.globalAlpha = 0.35;
    for (let i=0;i<70;i++){
      const sx = (i*97.3 + score*0.05) % (world.w+120) - 60;
      const sy = (i*53.7 + score*0.12) % world.h;
      ctx.fillStyle = 'rgba(255,255,255,.55)';
      ctx.fillRect(sx, sy, 2, 2);
    }
    ctx.restore();

    // platforms
    for (const p of platforms){
      if (p.broken) continue;
      let fill='rgba(255,255,255,.10)', edge='rgba(255,255,255,.16)', glow='rgba(76,230,255,.55)';
      if (p.type==='move'){ fill='rgba(76,230,255,.12)'; edge='rgba(76,230,255,.22)'; glow='rgba(76,230,255,.55)'; }
      if (p.type==='break'){ fill='rgba(255,124,156,.10)'; edge='rgba(255,124,156,.22)'; glow='rgba(255,124,156,.55)'; }

      roundRect(p.x,p.y,p.w,p.h,10);
      ctx.fillStyle=fill; ctx.fill();
      ctx.strokeStyle=edge; ctx.lineWidth=1.2; ctx.stroke();

      ctx.save();
      ctx.globalAlpha=0.22;
      ctx.shadowColor=glow; ctx.shadowBlur=14;
      ctx.strokeStyle=edge; ctx.lineWidth=2; ctx.stroke();
      ctx.restore();
    }

    // coins
    for (const c of coins){
      ctx.save();
      ctx.fillStyle='rgba(255,215,106,.95)';
      ctx.shadowColor='rgba(255,215,106,.75)';
      ctx.shadowBlur=14;
      ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=0.45;
      ctx.fillStyle='rgba(255,255,255,.9)';
      ctx.beginPath(); ctx.arc(c.x-3,c.y-3,c.r*0.35,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }

    // particles (behind)
    drawParticles();

    // player
    const col = getPlayerColor();
    ctx.save();
    ctx.shadowColor='rgba(76,230,255,.30)'; ctx.shadowBlur=18;
    roundRect(player.x,player.y,player.w,player.h,10);
    ctx.fillStyle=col; ctx.fill();
    ctx.shadowBlur=0;
    ctx.globalAlpha=0.22; ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.fillRect(player.x+6, player.y+10, player.w-12, 2);
    ctx.globalAlpha=1;

    // hat
    const hat = SAVE.cosmetics.hat || 'none';
    if (hat !== 'none'){
      if (hat === 'cap'){
        ctx.fillStyle='rgba(0,0,0,.35)';
        roundRect(player.x+2, player.y-10, player.w-4, 10, 6);
        ctx.fill();
        ctx.fillRect(player.x+player.w-10, player.y-4, 12, 4);
      } else if (hat === 'crown'){
        ctx.fillStyle='rgba(255,215,106,.95)';
        ctx.shadowColor='rgba(255,215,106,.55)';
        ctx.shadowBlur=12;
        ctx.beginPath();
        ctx.moveTo(player.x+3, player.y-2);
        ctx.lineTo(player.x+6, player.y-12);
        ctx.lineTo(player.x+player.w/2, player.y-4);
        ctx.lineTo(player.x+player.w-6, player.y-12);
        ctx.lineTo(player.x+player.w-3, player.y-2);
        ctx.closePath();
        ctx.fill();
        ctx.shadowBlur=0;
      } else if (hat === 'horns'){
        ctx.fillStyle='rgba(255,124,156,.95)';
        ctx.shadowColor='rgba(255,124,156,.55)';
        ctx.shadowBlur=12;
        ctx.beginPath(); ctx.moveTo(player.x+6, player.y+2); ctx.lineTo(player.x+1, player.y-10); ctx.lineTo(player.x+10, player.y-2); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(player.x+player.w-6, player.y+2); ctx.lineTo(player.x+player.w-1, player.y-10); ctx.lineTo(player.x+player.w-10, player.y-2); ctx.closePath(); ctx.fill();
        ctx.shadowBlur=0;
      }
    }

    // magnet ring
    if (stats.magnet>0){
      ctx.globalAlpha=0.12;
      ctx.strokeStyle='rgba(255,215,106,.95)';
      ctx.shadowColor='rgba(255,215,106,.45)';
      ctx.shadowBlur=18;
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(player.x+player.w/2, player.y+player.h/2, stats.magnet, 0, Math.PI*2); ctx.stroke();
      ctx.globalAlpha=1; ctx.shadowBlur=0;
    }
    ctx.restore();

    // particles (front)
    drawParticles();
  }

  // ===== Shop controls =====
  btnRestart.addEventListener('click', ()=>{ resetGame(); toast('–†–µ—Å—Ç–∞—Ä—Ç üöÄ'); });

  // ===== Start gating (so you ALWAYS see something) =====
  let running=false;
  btnStart.addEventListener('click', ()=>{
    startOverlay.style.display='none';
    resetGame();
    toast('–í–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º –ø–æ —ç–∫—Ä–∞–Ω—É üëÜ');
    running=true;
  });

  // also allow tapping overlay anywhere
  startOverlay.addEventListener('click', (e)=>{
    if (e.target===startOverlay) btnStart.click();
  });

  // ===== MAIN LOOP =====
  let last = now();
  function loop(){
    const t=now();
    let dt = (t-last)/16.666;
    dt = clamp(dt, 0.5, 2.2);
    last=t;

    if (running && !modal.classList.contains('on')){
      step(dt);
      stepParticles(dt);
    } else if (running){
      stepParticles(dt);
    }

    draw();
    requestAnimationFrame(loop);
  }

  // init state: draw start screen scene
  resetGame();
  syncUI();
  toast('–ù–∞–∂–º–∏ –°—Ç–∞—Ä—Ç');
  loop();

  // Shop open/close
  btnShop.addEventListener('click', ()=>{ modal.classList.add('on'); renderShop(); });
  btnClose.addEventListener('click', ()=>modal.classList.remove('on'));

  // tabs init
  tabUp.addEventListener('click', ()=>{ shopMode='up'; tabUp.classList.add('on'); tabCos.classList.remove('on'); renderShop(); });
  tabCos.addEventListener('click', ()=>{ shopMode='cos'; tabCos.classList.add('on'); tabUp.classList.remove('on'); renderShop(); });

})();
</script>
</body>
                               </html>
